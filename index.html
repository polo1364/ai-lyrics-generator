<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ê≠åË©ûÁîüÊàêÂô® Pro | Suno Â∞àÁî®</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(20, 20, 30, 0.8);
            --bg-input: rgba(30, 30, 45, 0.6);
            --border-color: rgba(255, 255, 255, 0.08);
            --border-glow: rgba(0, 212, 255, 0.3);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.85);
            --text-muted: rgba(255, 255, 255, 0.55);
            --accent-cyan: #00d4ff;
            --accent-magenta: #ff00aa;
            --accent-purple: #8b5cf6;
            --accent-orange: #ff6b35;
            --accent-green: #00ff88;
            --accent-yellow: #fbbf24;
            --gradient-main: linear-gradient(135deg, #00d4ff 0%, #8b5cf6 50%, #ff00aa 100%);
            --gradient-button: linear-gradient(135deg, #00d4ff 0%, #8b5cf6 100%);
            --gradient-warm: linear-gradient(135deg, #ff6b35 0%, #ff00aa 100%);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-glow: 0 0 40px rgba(0, 212, 255, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .bg-gradient {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
        }

        .bg-gradient::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 20%, rgba(0, 212, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 80%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse 50% 60% at 50% 50%, rgba(255, 0, 170, 0.08) 0%, transparent 50%);
            animation: bgFloat 20s ease-in-out infinite;
        }

        @keyframes bgFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(2%, 2%) rotate(1deg); }
            66% { transform: translate(-1%, 1%) rotate(-1deg); }
        }

        .grid-overlay {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(ellipse 80% 60% at 50% 30%, black, transparent);
        }

        .preset-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        .preset-row select {
            min-width: 220px;
        }

        .prompt-summary {
            margin-top: 15px;
            padding: 16px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.03);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .prompt-summary-icon {
            font-size: 18px;
        }

        .prompt-summary-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 6px 14px;
            width: 100%;
            color: var(--text-secondary);
            font-size: 0.92em;
        }

        .prompt-summary-content .label {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .result-actions .action-btn {
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.06);
        }

        .safety-panel {
            margin-top: 16px;
            padding: 14px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 191, 36, 0.4);
            background: rgba(255, 191, 36, 0.1);
        }

        .safety-panel h4 {
            margin-bottom: 8px;
            color: #fbbf24;
        }

        .safety-list {
            margin: 0;
            padding-left: 18px;
            color: var(--text-secondary);
        }

        .history-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-top: 20px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            background: rgba(255,255,255,0.02);
        }

        .history-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .diff-viewer {
            margin-top: 12px;
            padding: 12px;
            border-radius: var(--radius-md);
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            color: var(--text-secondary);
            max-height: 320px;
            overflow: auto;
        }

        .diff-add { color: #00ff88; }
        .diff-del { color: #ff6b6b; }

        .app-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient-main);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation: none !important;
                transition-duration: 0ms !important;
            }
            .bg-gradient::before,
            .logo-icon {
                animation: none !important;
            }
        }

        .logo-text { 
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .logo-title-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2em;
            font-weight: 700;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            line-height: 1.2;
        }

        .logo-subtitle {
            font-size: 0.85em;
            color: var(--text-secondary);
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .pro-badge {
            background: var(--gradient-warm);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.5em;
            font-weight: 700;
            letter-spacing: 1px;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            flex-shrink: 0;
        }

        .header-description {
            color: var(--text-secondary);
            font-size: 1em;
            max-width: 550px;
            margin: 0 auto;
        }

        /* Âç°ÁâáËàáÂçÄÂ°ä */
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 30px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.5), transparent);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .card:hover::before { opacity: 1; }
        .card:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-icon {
            width: 42px;
            height: 42px;
            background: var(--gradient-button);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ÂèØÊäòÁñäÂçÄÂ°ä */
        .collapsible-section {
            margin-bottom: 20px;
        }

        .section-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(0, 212, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s;
        }

        .section-toggle:hover {
            background: rgba(0, 212, 255, 0.12);
        }

        .section-toggle-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-toggle-icon {
            font-size: 1.3em;
        }

        .section-toggle-title {
            font-weight: 600;
            font-size: 1em;
            color: var(--text-primary);
        }

        .section-toggle-hint {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-left: 10px;
        }

        .section-toggle-arrow {
            font-size: 1.2em;
            transition: transform 0.3s;
            color: var(--accent-cyan);
        }

        .section-toggle.open .section-toggle-arrow {
            transform: rotate(180deg);
        }

        /* Âø´ÈÄüÈ¢®Ê†ºÊåâÈàïÁ∂≤Ê†º */
        .quick-style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .quick-style-btn {
            padding: 12px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .quick-style-btn:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-color: var(--accent-cyan);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
        }

        .quick-style-btn:active {
            transform: translateY(0);
        }

        .quick-style-btn.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.25) 0%, rgba(139, 92, 246, 0.25) 100%);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .section-content {
            display: none;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            animation: slideDown 0.3s ease-out;
        }

        .section-content.show, .section-content.open {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ë°®ÂñÆÊ®£Âºè */
        .form-group { margin-bottom: 20px; }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 0.95em;
            color: var(--text-primary);
        }

        .label-hint {
            font-size: 0.8em;
            color: var(--text-muted);
            font-weight: 400;
        }

        .selection-count {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: auto;
        }

        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.3s;
            outline: none;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-muted);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.15);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300d4ff' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 45px;
        }

        select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .form-row-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        @media (max-width: 900px) {
            .form-row-4 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .form-row, .form-row-3, .form-row-4 { grid-template-columns: 1fr; }
        }

        /* ÂñÆÈÅ∏ÊåâÈàïÁµÑ */
        .radio-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .radio-option {
            position: relative;
            cursor: pointer;
            flex: 1;
            min-width: 140px;
        }

        .radio-option input {
            position: absolute;
            opacity: 0;
        }

        .radio-option .radio-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: all 0.3s;
            font-size: 0.9em;
            text-align: center;
            color: var(--text-secondary);
        }

        .radio-option input:checked + .radio-label {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
            color: var(--text-primary);
        }

        .radio-option:hover .radio-label {
            border-color: rgba(0, 212, 255, 0.5);
        }

        /* Â§öÈÅ∏‰∏ãÊãâÈÅ∏ÂñÆ */
        .multi-select-container { position: relative; }

        .multi-select-display {
            width: 100%;
            min-height: 52px;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .multi-select-display:hover {
            border-color: rgba(0, 212, 255, 0.5);
        }

        .multi-select-display.active {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.15);
        }

        .selected-items {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .selected-tag {
            background: var(--gradient-button);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            animation: tagPop 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes tagPop {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        .selected-tag .remove-tag {
            cursor: pointer;
            font-size: 1.1em;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .selected-tag .remove-tag:hover { opacity: 1; }

        .multi-select-placeholder {
            color: var(--text-muted);
        }

        .multi-select-arrow {
            color: var(--accent-cyan);
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .multi-select-arrow.open {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-glow);
            border-radius: var(--radius-md);
            max-height: 350px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .multi-select-dropdown.show { display: block; }

        .dropdown-group {
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-group:last-child { border-bottom: none; }

        .dropdown-group-label {
            padding: 10px 15px;
            font-weight: 600;
            font-size: 0.85em;
            color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.05);
        }

        .dropdown-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dropdown-option:hover { background: rgba(0, 212, 255, 0.1); }
        .dropdown-option.selected { background: rgba(0, 212, 255, 0.15); }

        .dropdown-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-cyan);
        }

        .dropdown-option label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .dropdown-actions {
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .dropdown-actions button {
            flex: 1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .dropdown-actions button:hover {
            background: rgba(0, 212, 255, 0.2);
            color: var(--text-primary);
        }

        /* ÊåâÈàï */
        .btn {
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-button);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 212, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-cyan);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .loading.show { display: block; }

        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(0, 212, 255, 0.1);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1em;
        }

        /* ÁµêÊûúÂçÄÂüü */
        .result-section {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .result-section.show { display: block; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Â∞àËºØË≥áË®äÂçÄÂ°ä */
        .album-info {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(255, 0, 170, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
        }

        .album-name {
            font-size: 1.8em;
            font-weight: 700;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .album-meta {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .album-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .album-actions .action-btn {
            flex: none;
            min-width: 140px;
        }

        /* Ê≠åÊõ≤ÂàóË°® */
        .track-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .track-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all 0.3s;
        }

        .track-item:hover {
            border-color: var(--border-glow);
        }

        .track-item.active {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }

        .track-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .track-header:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .track-number {
            width: 36px;
            height: 36px;
            background: var(--gradient-button);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-title {
            font-weight: 600;
            font-size: 1.05em;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-style {
            font-size: 0.8em;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-toggle {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .track-item.active .track-toggle {
            background: var(--accent-cyan);
            transform: rotate(180deg);
        }

        .track-content {
            display: none;
            padding: 0 20px 20px;
            animation: slideDown 0.3s ease-out;
        }

        .track-item.active .track-content {
            display: block;
        }

        /* ÂñÆÊõ≤ÁâàÊú¨Ê®ôÁ±§ */
        .version-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .version-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .version-tab:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .version-tab.active {
            background: var(--gradient-button);
            color: white;
            border-color: transparent;
        }

        .version-content {
            display: none;
        }

        .version-content.active {
            display: block;
        }

        /* È¢®Ê†ºÊèêÁ§∫Ë©ûÂçÄÂ°ä */
        .style-prompt-section {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
        }

        .style-prompt-header {
            font-weight: 600;
            font-size: 0.95em;
            color: var(--accent-cyan);
            margin-bottom: 12px;
        }

        .style-prompt-output {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.6;
            word-break: break-word;
        }

        .copy-style-prompt-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(0, 212, 255, 0.15);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: var(--radius-sm);
            color: var(--accent-cyan);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-style-prompt-btn:hover {
            background: rgba(0, 212, 255, 0.25);
        }

        /* Ê≠åË©ûÈ°ØÁ§∫ */
        .lyrics-output {
            background: rgba(0, 0, 0, 0.4);
            border-radius: var(--radius-md);
            padding: 25px;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.95em;
            line-height: 1.9;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

        .lyrics-output::-webkit-scrollbar {
            width: 8px;
        }

        .lyrics-output::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .lyrics-output::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.3);
            border-radius: 4px;
        }

        /* Êìç‰ΩúÊåâÈàï */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-cyan);
            color: var(--text-primary);
        }

        .action-btn.copy-btn:hover { border-color: var(--accent-green); }
        .action-btn.suno-btn:hover { border-color: var(--accent-magenta); }
        .action-btn.export-btn:hover { border-color: var(--accent-yellow); }
        .action-btn.add-lib-btn:hover { border-color: var(--accent-purple); }

        /* Ë©ûÂ∫´ÂçÄÂüü */
        .library-section {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 25px;
            margin-top: 30px;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .library-title {
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .library-count {
            background: var(--accent-purple);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7em;
        }

        .global-actions {
            display: flex;
            gap: 10px;
        }

        .global-actions button {
            padding: 10px 18px;
            border-radius: var(--radius-md);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .global-actions button:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-cyan);
        }

        .library-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .library-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 18px;
            transition: all 0.3s;
        }

        .library-item:hover {
            border-color: var(--border-glow);
        }

        .lib-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .lib-item-header span:first-child {
            font-weight: 600;
            color: var(--text-primary);
        }

        .lib-item-date {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .lib-preview {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .lib-actions {
            display: flex;
            gap: 10px;
        }

        .lib-actions button {
            flex: 1;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.8em;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-load {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-cyan);
        }

        .btn-load:hover {
            background: rgba(0, 212, 255, 0.3);
        }

        .btn-delete {
            background: rgba(255, 107, 53, 0.2);
            color: var(--accent-orange);
        }

        .btn-delete:hover {
            background: rgba(255, 107, 53, 0.3);
        }

        /* ÊèêÁ§∫Âç°Áâá */
        .tips-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.08) 0%, rgba(0, 212, 255, 0.08) 100%);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: var(--radius-xl);
            padding: 25px;
            margin-top: 30px;
        }

        .tips-header {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--accent-green);
            margin-bottom: 15px;
        }

        .tips-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tips-list li {
            position: relative;
            padding-left: 25px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .tips-list li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--accent-green);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.85em;
        }

        /* Ë®≠ÂÆöÊåâÈàï */
        .settings-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-button);
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
            transition: all 0.3s;
            z-index: 1000;
        }

        .settings-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(0, 212, 255, 0.5);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            max-width: 450px;
            width: 100%;
            padding: 30px;
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 1.4em;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .info-box {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.85em;
        }

        .info-box a {
            color: var(--accent-cyan);
        }

        .modal-body { margin-bottom: 25px; }

        .modal-footer {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-md);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .modal-btn-primary {
            background: var(--gradient-button);
            color: white;
        }

        .modal-btn-primary:hover {
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }

        /* ÁîüÊàêÊ®°ÂºèÈÅ∏Êìá */
        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-option {
            flex: 1;
            position: relative;
            cursor: pointer;
        }

        .mode-option input {
            position: absolute;
            opacity: 0;
        }

        .mode-card {
            padding: 20px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            text-align: center;
            transition: all 0.3s;
        }

        .mode-option input:checked + .mode-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.2);
        }

        .mode-option:hover .mode-card {
            border-color: rgba(0, 212, 255, 0.5);
        }

        .mode-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .mode-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .mode-desc {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* Â∞àËºØÊ≠åÊõ≤Êï∏ÈáèÊªëÊ°ø */
        .album-count-section {
            display: none;
            padding: 20px;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .album-count-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .album-count-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .album-count-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .album-count-value {
            background: var(--accent-purple);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1em;
        }

        .album-count-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        .album-count-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--gradient-main);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.4);
            transition: transform 0.2s;
        }

        .album-count-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .album-count-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: var(--gradient-main);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8em;
            color: var(--text-muted);
        }

        @media (max-width: 640px) {
            .mode-selector {
                flex-direction: column;
            }
            
            .logo-title { font-size: 1.6em; }
            .logo-icon { width: 55px; height: 55px; font-size: 28px; }
            .app-container { padding: 20px 15px; }
            .card { padding: 20px; }
            .settings-btn { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="grid-overlay"></div>

    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üéµ</div>
                <div class="logo-text">
                    <div class="logo-title-wrapper">
                        <span class="logo-title">LYRICS AI</span>
                        <span class="pro-badge">PRO</span>
                    </div>
                    <span class="logo-subtitle">Suno Ê≠åË©ûÁîüÊàêÂô®</span>
                </div>
            </div>
            <p class="header-description">ÈÅãÁî® AI Âø´ÈÄüÁîüÊàêÂ∞àÊ•≠Ê≠åË©ûËàáÈ¢®Ê†ºÊèêÁ§∫Ë©ûÔºåÊîØÊè¥ÂñÆÊõ≤ËàáÂ∞àËºØÊ®°Âºè</p>
        </header>

        <!-- ‰∏ªÈ°åËº∏ÂÖ• -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üí°</div>
                <h2 class="card-title">Ââµ‰Ωú‰∏ªÈ°å</h2>
            </div>

            <div class="form-group">
                <label class="form-label">üé§ Ê≠åÊõ≤È°ûÂûã</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="songType" value="vocal" checked>
                        <span class="radio-label">üéôÔ∏è ‰∫∫ËÅ≤Ê≠åÊõ≤</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="songType" value="instrumental">
                        <span class="radio-label">üéπ Á¥îÈü≥Ê®Ç</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">‚ú® ‰∏ªÈ°å/ÈùàÊÑü</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="theme" placeholder="‰æãÂ¶Ç:Â§èÊó•Êµ∑ÈÇäÁöÑÈÇÇÈÄÖ„ÄÅÂ§±ÊàÄÁöÑÊ∑±Â§úÁç®ÁôΩ„ÄÅËøΩÂ§¢ÁöÑÈùíÊò•..." style="flex: 1;">
                    <button type="button" class="btn btn-secondary" id="generateThemeBtn" style="white-space: nowrap;">üé≤ AI ÈùàÊÑü</button>
                </div>
                <div class="preset-row">
                    <select id="presetSelect">
                        <option value="">ÈÅ∏ÊìáÂ∏∏Áî®È†êË®≠</option>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="applyPreset()">Â•óÁî®È†êË®≠</button>
                </div>
                <div class="prompt-summary" id="promptSummary">
                    <div class="prompt-summary-icon">üß≠</div>
                    <div class="prompt-summary-content">
                        <div><span class="label">Ê®°Âºè</span><br><span id="summaryMode">-</span></div>
                        <div><span class="label">Ë™ûË®Ä</span><br><span id="summaryLang">-</span></div>
                        <div><span class="label">È¢®Ê†º / ÊÉÖÊÑü</span><br><span id="summaryStyle">-</span></div>
                        <div><span class="label">Ê®ÇÂô®</span><br><span id="summaryInstruments">-</span></div>
                        <div><span class="label">ÁØÄÂ•è / Âπ¥‰ª£ / Ë™øÊÄß</span><br><span id="summaryMeta">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Èü≥Ê®ÇËàáÊ≠åË©ûË®≠ÂÆöÔºàÊï¥ÂêàÁâàÔºâ-->
        <div class="collapsible-section">
            <button class="section-toggle open" onclick="toggleSection('musicLyrics')">
                <div class="section-toggle-left">
                    <span class="section-toggle-icon">üéµ</span>
                    <span class="section-toggle-title">Èü≥Ê®ÇËàáÊ≠åË©ûË®≠ÂÆö</span>
                    <span class="section-toggle-hint">Âø´ÈÄüË®≠ÂÆö</span>
                </div>
                <span class="section-toggle-arrow" id="musicLyricsArrowIcon">‚ñº</span>
            </button>
            <div class="section-content show" id="musicLyricsSection">
                <!-- Âø´ÈÄüÈ¢®Ê†ºÈ†êË®≠ -->
                <div class="form-group">
                    <label class="form-label">‚ö° Âø´ÈÄüÈ¢®Ê†ºÔºà‰∏ÄÈçµÂ•óÁî®Ôºâ</label>
                    <div class="quick-style-grid">
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('pop_ballad')">üíï ÊäíÊÉÖÊÉÖÊ≠å</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('dance_edm')">üéâ ÈõªÂ≠êËàûÊõ≤</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('rock_band')">üé∏ ÊêñÊªæÊ®ÇÂúò</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('hiphop_rnb')">üé§ ÂòªÂìà R&B</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('folk_acoustic')">üåø Ê∞ëË¨†ÂéüËÅ≤</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('chinese_style')">üèÆ ‰∏≠ÂúãÈ¢®</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('kpop_jpop')">‚ú® Êó•ÈüìÊµÅË°å</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('lofi_chill')">‚òï Lo-Fi Chill</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('epic_cinematic')">üé¨ Âè≤Ë©©ÈõªÂΩ±</button>
                        <button type="button" class="quick-style-btn" onclick="applyQuickStyle('jazz_soul')">üé∑ ÁàµÂ£´ÈùàÈ≠Ç</button>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

                <!-- Ê†∏ÂøÉË®≠ÂÆö -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">üé∏ Èü≥Ê®ÇÈ¢®Ê†º <span class="selection-count" id="genreCount"></span></label>
                        <div class="multi-select-container" id="genreContainer">
                            <div class="multi-select-display" onclick="toggleDropdown('genre')">
                                <div class="selected-items" id="genreSelected">
                                    <span class="multi-select-placeholder">ÈªûÊìäÈÅ∏Êìá...</span>
                                </div>
                                <span class="multi-select-arrow" id="genreArrow">‚ñº</span>
                            </div>
                            <div class="multi-select-dropdown" id="genreDropdown">
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üé§ ÊµÅË°å/‰∏ªÊµÅ</div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Pop" value="Pop" onchange="updateMultiSelect('genre')"><label for="g_Pop">Pop ÊµÅË°å</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_KPop" value="K-Pop" onchange="updateMultiSelect('genre')"><label for="g_KPop">K-Pop ÈüìÊµÅ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_JPop" value="J-Pop" onchange="updateMultiSelect('genre')"><label for="g_JPop">J-Pop Êó•ÊµÅ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_CPop" value="C-Pop" onchange="updateMultiSelect('genre')"><label for="g_CPop">C-Pop ËèØË™ûÊµÅË°å</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Dance" value="Dance Pop" onchange="updateMultiSelect('genre')"><label for="g_Dance">Dance Pop ËàûÊõ≤</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Ballad" value="Ballad" onchange="updateMultiSelect('genre')"><label for="g_Ballad">Ballad ÊäíÊÉÖ</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üé∏ ÊêñÊªæ/ÈáëÂ±¨</div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Rock" value="Rock" onchange="updateMultiSelect('genre')"><label for="g_Rock">Rock ÊêñÊªæ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_AltRock" value="Alternative Rock" onchange="updateMultiSelect('genre')"><label for="g_AltRock">Alternative Âè¶È°ûÊêñÊªæ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Indie" value="Indie Rock" onchange="updateMultiSelect('genre')"><label for="g_Indie">Indie Áç®Á´ãÊêñÊªæ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Metal" value="Metal" onchange="updateMultiSelect('genre')"><label for="g_Metal">Metal ÈáëÂ±¨</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Punk" value="Punk" onchange="updateMultiSelect('genre')"><label for="g_Punk">Punk ÈæêÂÖã</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üéπ ÈõªÂ≠ê/EDM</div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_EDM" value="EDM" onchange="updateMultiSelect('genre')"><label for="g_EDM">EDM ÈõªÂ≠êËàûÊõ≤</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_House" value="House" onchange="updateMultiSelect('genre')"><label for="g_House">House Êµ©ÂÆ§</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Techno" value="Techno" onchange="updateMultiSelect('genre')"><label for="g_Techno">Techno ÈêµÂÖãË´æ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Trance" value="Trance" onchange="updateMultiSelect('genre')"><label for="g_Trance">Trance Âá∫Á•û</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Dubstep" value="Dubstep" onchange="updateMultiSelect('genre')"><label for="g_Dubstep">Dubstep</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Synthwave" value="Synthwave" onchange="updateMultiSelect('genre')"><label for="g_Synthwave">Synthwave ÂêàÊàêÂô®Êµ™ÊΩÆ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_LoFi" value="Lo-Fi" onchange="updateMultiSelect('genre')"><label for="g_LoFi">Lo-Fi</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üé§ ÂòªÂìà/R&B</div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_HipHop" value="Hip Hop" onchange="updateMultiSelect('genre')"><label for="g_HipHop">Hip Hop ÂòªÂìà</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Trap" value="Trap" onchange="updateMultiSelect('genre')"><label for="g_Trap">Trap</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_RnB" value="R&B" onchange="updateMultiSelect('genre')"><label for="g_RnB">R&B ÁØÄÂ•èËóçË™ø</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Soul" value="Soul" onchange="updateMultiSelect('genre')"><label for="g_Soul">Soul ÈùàÈ≠ÇÊ®Ç</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üé∑ ÁàµÂ£´/ËóçË™ø</div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Jazz" value="Jazz" onchange="updateMultiSelect('genre')"><label for="g_Jazz">Jazz ÁàµÂ£´</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Blues" value="Blues" onchange="updateMultiSelect('genre')"><label for="g_Blues">Blues ËóçË™ø</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Bossa" value="Bossa Nova" onchange="updateMultiSelect('genre')"><label for="g_Bossa">Bossa Nova Â∑¥Ëñ©Ë´æÁì¶</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üåç ‰∏ñÁïå/Ê∞ëÊóè</div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Folk" value="Folk" onchange="updateMultiSelect('genre')"><label for="g_Folk">Folk Ê∞ëË¨†</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Country" value="Country" onchange="updateMultiSelect('genre')"><label for="g_Country">Country ÈÑâÊùë</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Reggae" value="Reggae" onchange="updateMultiSelect('genre')"><label for="g_Reggae">Reggae Èõ∑È¨º</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Latin" value="Latin" onchange="updateMultiSelect('genre')"><label for="g_Latin">Latin Êãâ‰∏Å</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Chinese" value="Chinese Traditional" onchange="updateMultiSelect('genre')"><label for="g_Chinese">Chinese ‰∏≠ÂúãÈ¢®</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üéª Âè§ÂÖ∏/ÈÖçÊ®Ç</div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Classical" value="Classical" onchange="updateMultiSelect('genre')"><label for="g_Classical">Classical Âè§ÂÖ∏</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Orchestra" value="Orchestral" onchange="updateMultiSelect('genre')"><label for="g_Orchestra">Orchestral ÁÆ°Âº¶Ê®Ç</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Cinematic" value="Cinematic" onchange="updateMultiSelect('genre')"><label for="g_Cinematic">Cinematic ÈõªÂΩ±ÈÖçÊ®Ç</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="g_Ambient" value="Ambient" onchange="updateMultiSelect('genre')"><label for="g_Ambient">Ambient Ê∞õÂúç</label></div>
                                </div>
                                <div class="dropdown-actions">
                                    <button type="button" onclick="clearAll('genre')">Ê∏ÖÈô§ÂÖ®ÈÉ®</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üí´ ÊÉÖÊÑüÊ∞õÂúç <span class="selection-count" id="moodCount"></span></label>
                        <div class="multi-select-container" id="moodContainer">
                            <div class="multi-select-display" onclick="toggleDropdown('mood')">
                                <div class="selected-items" id="moodSelected">
                                    <span class="multi-select-placeholder">ÈªûÊìäÈÅ∏Êìá...</span>
                                </div>
                                <span class="multi-select-arrow" id="moodArrow">‚ñº</span>
                            </div>
                            <div class="multi-select-dropdown" id="moodDropdown">
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üòä Ê≠£ÂêëÊÉÖÊÑü</div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Happy" value="Happy" onchange="updateMultiSelect('mood')"><label for="m_Happy">Happy Ê≠°Ê®Ç</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Uplifting" value="Uplifting" onchange="updateMultiSelect('mood')"><label for="m_Uplifting">Uplifting ÊåØÂ•Æ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Romantic" value="Romantic" onchange="updateMultiSelect('mood')"><label for="m_Romantic">Romantic Êµ™Êº´</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Hopeful" value="Hopeful" onchange="updateMultiSelect('mood')"><label for="m_Hopeful">Hopeful Â∏åÊúõ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Playful" value="Playful" onchange="updateMultiSelect('mood')"><label for="m_Playful">Playful ‰øèÁöÆ</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üò¢ ÊÜÇÈ¨±ÊÉÖÊÑü</div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Sad" value="Sad" onchange="updateMultiSelect('mood')"><label for="m_Sad">Sad ÊÇ≤ÂÇ∑</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Melancholic" value="Melancholic" onchange="updateMultiSelect('mood')"><label for="m_Melancholic">Melancholic ÊÜÇÈ¨±</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Nostalgic" value="Nostalgic" onchange="updateMultiSelect('mood')"><label for="m_Nostalgic">Nostalgic Êá∑Ëàä</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Bittersweet" value="Bittersweet" onchange="updateMultiSelect('mood')"><label for="m_Bittersweet">Bittersweet Ëã¶Áîú</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">‚ö° Âº∑ÁÉàÊÉÖÊÑü</div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Energetic" value="Energetic" onchange="updateMultiSelect('mood')"><label for="m_Energetic">Energetic Ê¥ªÂäõ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Aggressive" value="Aggressive" onchange="updateMultiSelect('mood')"><label for="m_Aggressive">Aggressive ÊøÄÈÄ≤</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Passionate" value="Passionate" onchange="updateMultiSelect('mood')"><label for="m_Passionate">Passionate ÁÜ±ÊÉÖ</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Intense" value="Intense" onchange="updateMultiSelect('mood')"><label for="m_Intense">Intense Âº∑ÁÉà</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Dark" value="Dark" onchange="updateMultiSelect('mood')"><label for="m_Dark">Dark ÈªëÊöó</label></div>
                                </div>
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üßò Âπ≥ÈùúÊÉÖÊÑü</div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Calm" value="Calm" onchange="updateMultiSelect('mood')"><label for="m_Calm">Calm Âπ≥Èùú</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Dreamy" value="Dreamy" onchange="updateMultiSelect('mood')"><label for="m_Dreamy">Dreamy Â§¢Âπª</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Peaceful" value="Peaceful" onchange="updateMultiSelect('mood')"><label for="m_Peaceful">Peaceful ÂíåÂπ≥</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="m_Ethereal" value="Ethereal" onchange="updateMultiSelect('mood')"><label for="m_Ethereal">Ethereal Á©∫Èùà</label></div>
                                </div>
                                <div class="dropdown-actions">
                                    <button type="button" onclick="clearAll('mood')">Ê∏ÖÈô§ÂÖ®ÈÉ®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰∫∫ËÅ≤ËàáË™ûË®Ä -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">üë§ ‰∫∫ËÅ≤È°ûÂûã</label>
                        <select id="voice">
                            <option value="Male vocal">Áî∑ËÅ≤</option>
                            <option value="Female vocal">Â•≥ËÅ≤</option>
                            <option value="Duet, male and female">Áî∑Â•≥Â∞çÂî±</option>
                            <option value="Choir">ÂêàÂî±Âúò</option>
                            <option value="Child vocal">Á´•ËÅ≤</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üåê Ê≠åË©ûË™ûË®Ä <span class="selection-count" id="languageCount"></span></label>
                        <div class="multi-select-container" id="languageContainer">
                            <div class="multi-select-display" onclick="toggleDropdown('language')">
                                <div class="selected-items" id="languageSelected">
                                    <span class="multi-select-placeholder">ÈªûÊìäÈÅ∏ÊìáÔºàÂèØÂ§öÈÅ∏Ôºâ...</span>
                                </div>
                                <span class="multi-select-arrow" id="languageArrow">‚ñº</span>
                            </div>
                            <div class="multi-select-dropdown" id="languageDropdown">
                                <div class="dropdown-group">
                                    <div class="dropdown-group-label">üåç ÈÅ∏ÊìáË™ûË®ÄÔºàÂèØÊ∑∑Êê≠Ôºâ</div>
                                    <div class="dropdown-option"><input type="checkbox" id="lang_zh" value="ÁπÅÈ´î‰∏≠Êñá" onchange="updateMultiSelect('language')"><label for="lang_zh">ÁπÅÈ´î‰∏≠Êñá</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="lang_en" value="Ëã±Êñá" onchange="updateMultiSelect('language')"><label for="lang_en">Ëã±Êñá English</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="lang_jp" value="Êó•Êñá" onchange="updateMultiSelect('language')"><label for="lang_jp">Êó•Êñá Êó•Êú¨Ë™û</label></div>
                                    <div class="dropdown-option"><input type="checkbox" id="lang_kr" value="ÈüìÊñá" onchange="updateMultiSelect('language')"><label for="lang_kr">ÈüìÊñá ÌïúÍµ≠Ïñ¥</label></div>
                                </div>
                                <div class="dropdown-actions">
                                    <button type="button" onclick="clearAll('language')">Ê∏ÖÈô§ÂÖ®ÈÉ®</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ê≠åË©ûÈ¢®Ê†º -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">‚úçÔ∏è Ê≠åË©ûÈ¢®Ê†º</label>
                        <select id="lyricStyle">
                            <option value="">Ëá™ÂãïÔºàAI Êô∫ËÉΩÈÅ∏ÊìáÔºâ</option>
                            <option value="Áõ¥ÁôΩÊïò‰∫ã">Áõ¥ÁôΩÊïò‰∫ã - Á∞°ÂñÆÁõ¥Êé•</option>
                            <option value="ÊÑèË±°Ë©©ÊÑè">ÊÑèË±°Ë©©ÊÑè - ÊñáËóùÂîØÁæé</option>
                            <option value="ÊïÖ‰∫ãÊÄß">ÊïÖ‰∫ãÊÄß - Êïò‰∫ãÈã™Èô≥</option>
                            <option value="Âè£Ë™ûÂåñ">Âè£Ë™ûÂåñ - Ë¶™ÂàáËá™ÁÑ∂</option>
                            <option value="Â∞çË©±Âºè">Â∞çË©±Âºè - ‰Ω†Êàë‰∫íÂãï</option>
                            <option value="ÊäΩË±°Ê¶ÇÂøµ">ÊäΩË±°Ê¶ÇÂøµ - Âì≤ÊÄùÊ∑±ÈÇÉ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üé≠ Ê≠åÊõ≤Ê∞õÂúç</label>
                        <select id="songVibe">
                            <option value="">Ëá™Âãï</option>
                            <option value="radio-ready, catchy, mainstream">‰∏ªÊµÅÂïÜÊ•≠ - ÊúóÊúó‰∏äÂè£</option>
                            <option value="indie, artistic, unique">Áç®Á´ãËóùË°ì - ÂÄãÊÄßÁç®Áâπ</option>
                            <option value="emotional, heartfelt, sincere">ÁúüÊëØÂãï‰∫∫ - Ëß∏ÂãïÂøÉÂº¶</option>
                            <option value="party, fun, groovy">Ê¥æÂ∞çÂó®Ê≠å - ÂãïÊÑüÂçÅË∂≥</option>
                            <option value="chill, relaxed, laid-back">ÊîæÈ¨ÜÁôÇÁôí - ËàíÈÅ©ÊÑúÊÑè</option>
                            <option value="epic, grand, powerful">Âè≤Ë©©Á£ÖÁ§¥ - Ê∞£Âã¢ÊÅ¢ÂÆè</option>
                        </select>
                    </div>
                </div>

                <!-- Èö±ËóèÁöÑÈÄ≤ÈöéÈÅ∏È†ÖÔºàÊô∫ËÉΩËá™ÂãïÂ°´ÂÖ•Ôºâ -->
                <input type="hidden" id="bpm" value="">
                <input type="hidden" id="era" value="">
                <input type="hidden" id="key" value="">
                <input type="hidden" id="region" value="">
                <input type="hidden" id="production" value="">
                <input type="hidden" id="technique" value="">
                <input type="hidden" id="vocalEffect" value="">
                <input type="hidden" id="structure" value="Ê®ôÊ∫ñ (Verse-Chorus-Verse-Chorus-Bridge-Chorus)">
                
                <!-- Ê®ÇÂô®ÈÅ∏ÊìáÔºàÈö±ËóèÔºåÁî±Âø´ÈÄüÈ¢®Ê†ºËá™ÂãïÂ°´ÂÖ•Ôºâ -->
                <div style="display:none;" id="instrumentsContainer">
                    <div id="instrumentsSelected"></div>
                    <div id="instrumentsDropdown">
                        <input type="checkbox" id="i_Piano" value="Piano">
                        <input type="checkbox" id="i_Synth" value="Synthesizer">
                        <input type="checkbox" id="i_Organ" value="Organ">
                        <input type="checkbox" id="i_Rhodes" value="Rhodes">
                        <input type="checkbox" id="i_AcousticGuitar" value="Acoustic Guitar">
                        <input type="checkbox" id="i_ElectricGuitar" value="Electric Guitar">
                        <input type="checkbox" id="i_Ukulele" value="Ukulele">
                        <input type="checkbox" id="i_Violin" value="Violin">
                        <input type="checkbox" id="i_Cello" value="Cello">
                        <input type="checkbox" id="i_Strings" value="String Orchestra">
                        <input type="checkbox" id="i_Harp" value="Harp">
                        <input type="checkbox" id="i_Erhu" value="Erhu">
                        <input type="checkbox" id="i_Guzheng" value="Guzheng">
                        <input type="checkbox" id="i_Pipa" value="Pipa">
                        <input type="checkbox" id="i_Bass" value="Bass Guitar">
                        <input type="checkbox" id="i_SynthBass" value="Synth Bass">
                        <input type="checkbox" id="i_808" value="808 Bass">
                        <input type="checkbox" id="i_Upright" value="Upright Bass">
                        <input type="checkbox" id="i_Drums" value="Drums">
                        <input type="checkbox" id="i_ElectronicDrums" value="Electronic Drums">
                        <input type="checkbox" id="i_Percussion" value="Percussion">
                        <input type="checkbox" id="i_Congas" value="Congas">
                        <input type="checkbox" id="i_Timpani" value="Timpani">
                        <input type="checkbox" id="i_Taiko" value="Taiko">
                        <input type="checkbox" id="i_Saxophone" value="Saxophone">
                        <input type="checkbox" id="i_Trumpet" value="Trumpet">
                        <input type="checkbox" id="i_Trombone" value="Trombone">
                        <input type="checkbox" id="i_Flute" value="Flute">
                        <input type="checkbox" id="i_Clarinet" value="Clarinet">
                        <input type="checkbox" id="i_Harmonica" value="Harmonica">
                        <input type="checkbox" id="i_Bagpipes" value="Bagpipes">
                        <input type="checkbox" id="i_Pads" value="Synth Pads">
                        <input type="checkbox" id="i_Arpeggio" value="Arpeggio">
                        <input type="checkbox" id="i_Lead" value="Lead Synth">
                        <input type="checkbox" id="i_DrumMachine" value="Drum Machine">
                        <input type="checkbox" id="i_Sampler" value="Sampler">
                        <input type="checkbox" id="i_FX" value="Sound Effects">
                        <input type="checkbox" id="i_BackingVocals" value="Backing Vocals">
                        <input type="checkbox" id="i_Choir" value="Choir">
                        <input type="checkbox" id="i_VocalChops" value="Vocal Chops">
                    </div>
                </div>
            </div>
        </div>

        <!-- ÈÄ≤ÈöéË®≠ÂÆöÔºàÂèØÈÅ∏Â±ïÈñãÔºâ -->
        <div class="collapsible-section">
            <button class="section-toggle" onclick="toggleSection('advanced')">
                <div class="section-toggle-left">
                    <span class="section-toggle-icon">üéõÔ∏è</span>
                    <span class="section-toggle-title">ÈÄ≤ÈöéÂæÆË™ø</span>
                    <span class="section-toggle-hint">ÂèØÈÅ∏„ÉªÊõ¥Â§öÊéßÂà∂</span>
                </div>
                <span class="section-toggle-arrow" id="advancedArrowIcon">‚ñº</span>
            </button>
            <div class="section-content" id="advancedSection">
                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">ü•Å ÁØÄÂ•èÈÄüÂ∫¶</label>
                        <select id="bpmSelect" onchange="document.getElementById('bpm').value=this.value">
                            <option value="">Ëá™Âãï</option>
                            <option value="Slow tempo, 60-80 BPM">ÊÖ¢Êùø 60-80</option>
                            <option value="Medium tempo, 80-100 BPM">‰∏≠ÊÖ¢ 80-100</option>
                            <option value="Medium tempo, 100-120 BPM">‰∏≠Êùø 100-120</option>
                            <option value="Fast tempo, 120-140 BPM">Âø´Êùø 120-140</option>
                            <option value="Very fast, 140-170 BPM">Ê•µÂø´ 140-170</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìÖ Âπ¥‰ª£È¢®Ê†º</label>
                        <select id="eraSelect" onchange="document.getElementById('era').value=this.value">
                            <option value="">Ëá™Âãï</option>
                            <option value="80s style">80Âπ¥‰ª£</option>
                            <option value="90s style">90Âπ¥‰ª£</option>
                            <option value="2000s style">2000Âπ¥‰ª£</option>
                            <option value="Modern, 2020s">Áèæ‰ª£</option>
                            <option value="Futuristic">Êú™‰æÜÊÑü</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üéöÔ∏è Ë£Ω‰ΩúË≥™ÊÑü</label>
                        <select id="productionSelect" onchange="document.getElementById('production').value=this.value">
                            <option value="">Ëá™Âãï</option>
                            <option value="Polished, radio-ready">Á≤æÁ∑ªÂïÜÊ•≠</option>
                            <option value="Raw, live recording">ÂéüÂßãÁèæÂ†¥</option>
                            <option value="Lo-fi, vintage">‰Ωé‰øùÁúüÂæ©Âè§</option>
                            <option value="Acoustic, unplugged">‰∏çÊèíÈõªÂéüËÅ≤</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ëº∏Âá∫Ë®≠ÂÆö -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üì§</div>
                <h2 class="card-title">Ëº∏Âá∫Ë®≠ÂÆö</h2>
            </div>

            <div class="form-group">
                <label class="form-label">üéµ ÁîüÊàêÊ®°Âºè</label>
                <div class="mode-selector">
                    <label class="mode-option">
                        <input type="radio" name="generateMode" value="single" checked onchange="toggleAlbumSettings()">
                        <div class="mode-card">
                            <div class="mode-icon">üé§</div>
                            <div class="mode-title">ÂñÆÊõ≤Ê®°Âºè</div>
                            <div class="mode-desc">ÁîüÊàê 1-3 ÂÄãÁâàÊú¨ÁöÑÊ≠åË©û</div>
                        </div>
                    </label>
                    <label class="mode-option">
                        <input type="radio" name="generateMode" value="album" onchange="toggleAlbumSettings()">
                        <div class="mode-card">
                            <div class="mode-icon">üíø</div>
                            <div class="mode-title">Â∞àËºØÊ®°Âºè</div>
                            <div class="mode-desc">ÁîüÊàêÂÆåÊï¥Â∞àËºØ (5-10È¶ñ)</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- ÂñÆÊõ≤ÁâàÊú¨ÈÅ∏Êìá -->
            <div class="form-row-3" id="singleSettings">
                <div class="form-group">
                    <label class="form-label">‚è±Ô∏è Ê≠åÊõ≤ÊôÇÈï∑</label>
                    <select id="duration">
                        <option value="Short, 2 minutes">Áü≠Áâà 2ÂàÜÈêò</option>
                        <option value="Standard, 3 minutes" selected>Ê®ôÊ∫ñ 3ÂàÜÈêò</option>
                        <option value="Extended, 4-5 minutes">Âä†Èï∑ 4-5ÂàÜÈêò</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">üî¢ ÁîüÊàêÁâàÊú¨Êï∏</label>
                    <select id="count">
                        <option value="1">1 ÂÄãÁâàÊú¨</option>
                        <option value="2">2 ÂÄãÁâàÊú¨</option>
                        <option value="3">3 ÂÄãÁâàÊú¨</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">üéØ ÂâµÊÑèÁ®ãÂ∫¶</label>
                    <select id="creativity">
                        <option value="0.7">‰øùÂÆà (Á©©ÂÆö)</option>
                        <option value="0.85" selected>Âπ≥Ë°°</option>
                        <option value="0.95">Â§ßËÜΩ (ÂâµÊÑè)</option>
                        <option value="1.0">ÂØ¶È©óÊÄß</option>
                    </select>
                </div>
            </div>

            <!-- Â∞àËºØË®≠ÂÆö -->
            <div class="album-count-section" id="albumSettings">
                <div class="album-count-header">
                    <span class="album-count-label">üíø Â∞àËºØÊ≠åÊõ≤Êï∏Èáè</span>
                    <span class="album-count-value" id="albumCountValue">7 È¶ñ</span>
                </div>
                <input type="range" class="album-count-slider" id="albumCount" min="5" max="10" value="7" oninput="updateAlbumCount()">
                <div class="slider-labels">
                    <span>5È¶ñ</span>
                    <span>10È¶ñ</span>
                </div>
                
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">‚è±Ô∏è ÂñÆÊõ≤ÊôÇÈï∑</label>
                        <select id="albumDuration">
                            <option value="Short, 2 minutes">Áü≠Áâà 2ÂàÜÈêò</option>
                            <option value="Standard, 3 minutes" selected>Ê®ôÊ∫ñ 3ÂàÜÈêò</option>
                            <option value="Extended, 4-5 minutes">Âä†Èï∑ 4-5ÂàÜÈêò</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">üéØ ÂâµÊÑèÁ®ãÂ∫¶</label>
                        <select id="albumCreativity">
                            <option value="0.7">‰øùÂÆà (Á©©ÂÆö)</option>
                            <option value="0.85" selected>Âπ≥Ë°°</option>
                            <option value="0.95">Â§ßËÜΩ (ÂâµÊÑè)</option>
                            <option value="1.0">ÂØ¶È©óÊÄß</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">üìù È°çÂ§ñË¶ÅÊ±Ç <span class="label-hint">ÔºàÈÅ∏Â°´Ôºâ</span></label>
                <textarea id="requirements" placeholder="‰æãÂ¶Ç:Âä†ÂÖ•ËΩâÈü≥ÊäÄÂ∑ß„ÄÅÁâπÂÆöÊäºÈüªÊñπÂºè„ÄÅÊüêÁ®ÆÊÉÖÂ¢ÉÊèèÂØ´..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" id="randomFillBtn">üé≤ Èö®Ê©üÈùàÊÑü</button>
                <button class="btn btn-primary" id="generateBtn">‚ú® ÈñãÂßãÁîüÊàê</button>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p class="loading-text">AI Ê≠£Âú®ÁÇ∫‰Ω†Ââµ‰Ωú‰∏≠...</p>
        </div>

        <!-- ÁµêÊûúÂçÄÂüü -->
        <div class="result-section" id="resultSection">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üé∂</div>
                    <h2 class="card-title">ÁîüÊàêÁµêÊûú</h2>
                    <div class="result-actions">
                        <button class="action-btn copy-btn" onclick="copyPrompt()">üìã Ë§áË£ΩÊèêÁ§∫Ë©û</button>
                        <button class="action-btn export-btn" onclick="exportMarkdown()">üìù ÂåØÂá∫ Markdown</button>
                    </div>
                </div>
                
                <!-- Â∞àËºØË≥áË®ä (Â∞àËºØÊ®°ÂºèÈ°ØÁ§∫) -->
                <div class="album-info" id="albumInfo" style="display: none;">
                    <div class="album-name" id="albumName"></div>
                    <div class="album-meta" id="albumMeta"></div>
                    <div class="album-actions">
                        <button class="action-btn add-lib-btn" onclick="addAlbumToLibrary()">üìö Êî∂ËóèÊï¥ÂºµÂ∞àËºØ</button>
                        <button class="action-btn export-btn" onclick="exportAlbum()">üíæ ÂåØÂá∫Êï¥ÂºµÂ∞àËºØ</button>
                    </div>
                </div>
                
                <!-- ÂñÆÊõ≤ÁâàÊú¨Ê®ôÁ±§ -->
                <div class="version-tabs" id="versionTabs"></div>
                
                <!-- Ê≠åÊõ≤ÂàóË°® (Â∞àËºØÊ®°Âºè) -->
                <div class="track-list" id="trackList"></div>
                
                <!-- ÂñÆÊõ≤ÂÖßÂÆπÂÆπÂô® -->
                <div id="versionsContainer"></div>
                
                <div class="safety-panel" id="safetyPanel" style="display:none;">
                    <h4>‚ö†Ô∏è Ëá™ÂãïÊ™¢Êü•</h4>
                    <ul class="safety-list" id="safetyList"></ul>
                    <div class="action-buttons" style="margin-top:10px;">
                        <button class="action-btn copy-btn" onclick="copySafetyPrompt()">üìã Ë§áË£Ω‰øÆÊ≠£ÊèêÁ§∫Ë©û</button>
                    </div>
                </div>
            </div>
        </div>

        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importLyrics(event)">

        <!-- Ë©ûÂ∫´ÂçÄÂüü -->
        <div class="library-section">
            <div class="library-header">
                <h2 class="library-title">üìö ÊàëÁöÑË©ûÂ∫´ <span class="library-count" id="libCount">0</span></h2>
                <div class="global-actions">
                    <button class="import-btn" onclick="document.getElementById('importFile').click()">üì• ÂåØÂÖ•</button>
                    <button class="export-btn" onclick="exportLibrary()">üì§ ÂåØÂá∫</button>
                </div>
            </div>
            <div id="libraryList" class="library-list"></div>
        </div>

        <div class="history-card">
            <div class="library-header" style="margin-bottom:12px;">
                <h2 class="library-title">üïí Ê≠∑Âè≤ÁâàÊú¨ <span class="library-count" id="historyCount">0</span></h2>
            </div>
            <div class="history-list" id="historyList"></div>
            <div id="diffViewer" class="diff-viewer" style="display:none;"></div>
        </div>

        <input type="file" id="importLibraryFile" accept=".json" style="display: none;" onchange="importLibrary(event)">

        <div class="tips-card">
            <div class="tips-header">üí° ‰ΩøÁî®ÊèêÁ§∫</div>
            <ul class="tips-list">
                <li>ÂñÆÊõ≤Ê®°ÂºèÂèØÁîüÊàê 1-3 ÂÄã‰∏çÂêåÈ¢®Ê†ºÁöÑÁâàÊú¨</li>
                <li>Â∞àËºØÊ®°ÂºèÂèØ‰∏ÄÊ¨°ÁîüÊàê 5-10 È¶ñÂÆåÊï¥Ê≠åÊõ≤ÔºåÂåÖÂê´Â∞àËºØÂêçÁ®±ÂíåÊ≠åÂêç</li>
                <li>ÈªûÊìäÂ∞àËºØ‰∏≠ÁöÑÊ≠åÊõ≤ÊåâÈàïÂèØÂ±ïÈñã/Êî∂ÂêàÊ≠åË©ûÂÖßÂÆπ</li>
                <li>Á¥îÈü≥Ê®ÇÊ®°ÂºèÊúÉÁîüÊàêÈü≥Ê®ÇÁµêÊßãÊèèËø∞ÔºåÈÅ©ÂêàÈÖçÊ®ÇË£Ω‰Ωú</li>
                <li>ÊâÄÊúâË®≠ÂÆöÊúÉËá™ÂãïÂÑ≤Â≠òÔºåÈáçÊñ∞Êï¥ÁêÜ‰∏çÊúÉÈÅ∫Â§±</li>
            </ul>
        </div>

        <footer class="footer">
            <p>Powered by Google Gemini AI ¬∑ Made with ‚ù§Ô∏è</p>
        </footer>
    </div>

    <button class="settings-btn" onclick="openApiModal()" title="API Ë®≠ÂÆö">‚öôÔ∏è</button>

    <!-- API Modal -->
    <div id="apiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîë API ÈáëÈë∞Ë®≠ÂÆö</h2>
                <p>Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ Google Gemini API ÈáëÈë∞</p>
            </div>
            <div class="info-box">
                <p><strong>Â¶Ç‰ΩïÂèñÂæó?</strong></p>
                <p>1. ÂâçÂæÄ <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a></p>
                <p>2. ÁôªÂÖ•‰∏¶Âª∫Á´ã API Key</p>
            </div>
            <div class="modal-body">
                <input type="password" id="apiKeyInput" placeholder="AIza..." autocomplete="off">
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeApiModal()">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-primary" onclick="saveApiKey()">ÂÑ≤Â≠ò</button>
            </div>
        </div>
    </div>

    <script>
        // ===== ÂÖ®ÂüüËÆäÊï∏ =====
        let db = null;
        const FETCH_TIMEOUT = 25000;

        function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(new Error('timeout')), timeout);
            const merged = { ...options, signal: controller.signal };
            return fetch(url, merged).finally(() => clearTimeout(id));
        }
        const DB_NAME = 'LyricsGeneratorProDB';
        const DB_VERSION = 3;
        const STORE_NAME = 'formState';
        const API_KEY_STORE = 'apiKeyStore';
        const LIBRARY_STORE = 'libraryStore';
        const RESULT_STORE = 'resultStore';
        const HISTORY_LIMIT = 8;
        const PRESETS = [
            { name: 'ÊµÅË°åÊäíÊÉÖ ¬∑ ÈõôË™û', theme: 'ÈúìËôπÂ§úËâ≤‰∏ãÁöÑÂëäÁôΩ', genre: ['Pop'], mood: ['Romantic', 'Melancholic'], language: ['ÁπÅÈ´î‰∏≠Êñá', 'English'], structure: 'Ê®ôÊ∫ñ Verse / Pre / Chorus', bpm: '80-100 BPM (ÊäíÊÉÖÁØÄÂ•è)', voice: 'Female Vocal', vocalEffect: 'ÊüîÂíåÊ∑∑Èüø (Light Reverb)', production: 'Polished (Á≤æÁ∑ªË£Ω‰Ωú)' },
            { name: 'EDM ËàûÊõ≤', theme: 'Â§èÂ§úÊµ∑Â≥∂Ê¥æÂ∞ç', genre: ['EDM', 'House'], mood: ['Energetic', 'Party'], instruments: ['Drums', 'Synth Pads', 'Lead Synth'], language: ['English'], bpm: '120-128 BPM (ÂæãÂãïËàûÊõ≤)', structure: 'EDM ÂÖ∏Âûã (Intro/Build/Drop/Break/Drop)', voice: 'Female Vocal', vocalEffect: 'ÈõªÈü≥Ë™øËâ≤ (Vocoder / FX)', production: 'Modern (Áèæ‰ª£ÊÑü)' },
            { name: 'Lo-fi Chill', theme: 'Ê∑±Â§úÊõ∏Ê°åËàáÈõ®ËÅ≤', genre: ['Lo-fi', 'Chillhop'], mood: ['Calm', 'Dreamy'], instruments: ['Guitar', 'Synth Pads', 'Drums'], language: ['English'], bpm: '70-90 BPM (ËºïÈ¨ÜÁØÄÂ•è)', voice: 'Male Vocal', vocalEffect: 'Ëá™ÁÑ∂ (Minimal FX)', production: 'Warm / Analog (Ê∫´ÊöñÈ°ûÊØî)' },
            { name: 'ÈõªÂΩ±ÈÖçÊ®Ç ¬∑ Âè≤Ë©©', theme: 'ÈªéÊòéÂâçÁöÑÈÅ†ÂæÅ', genre: ['Cinematic', 'Orchestral'], mood: ['Epic', 'Hopeful'], instruments: ['Strings', 'Brass', 'Drums', 'Choir'], language: ['Latin', 'English'], bpm: 'Slow-Build (60-90 BPM)', structure: 'ÈÖçÊ®ÇÈã™Èô≥ (Intro / Build / Climax / Outro)', voice: 'Choir', vocalEffect: 'Hall Reverb (Â§ßÂª≥)', production: 'Cinematic (ÈõªÂΩ±ÊÑü)' },
            { name: 'ÂòªÂìà ¬∑ ÂèõÈÄÜ', theme: 'Âú∞‰∏ãÈêµË£°ÁöÑÂíÜÂìÆ', genre: ['Hip-Hop', 'Trap'], mood: ['Aggressive', 'Rebellious'], instruments: ['Drums', '808 Bass', 'Lead Synth'], language: ['ÁπÅÈ´î‰∏≠Êñá'], bpm: '140-160 BPM (Trap ÁØÄÂ•è)', structure: 'Verse / Hook ‰∫§Êõø', voice: 'Male Vocal', vocalEffect: 'ËºïÂ∫¶ Auto-tune', production: 'Gritty (Á≤óÁ≥ôË≥™ÊÑü)' }
        ];
        let generatedVersions = [];
        let generatedAlbum = null;
        let savedSongs = [];
        let generatedHistory = [];
        let lastPromptText = '';

        // ===== IndexedDB =====
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) database.createObjectStore(STORE_NAME);
                    if (!database.objectStoreNames.contains(API_KEY_STORE)) database.createObjectStore(API_KEY_STORE);
                    if (!database.objectStoreNames.contains(LIBRARY_STORE)) database.createObjectStore(LIBRARY_STORE);
                    if (!database.objectStoreNames.contains(RESULT_STORE)) database.createObjectStore(RESULT_STORE);
                };
            });
        }

        function saveToIndexedDB(storeName, key, data) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error('DB not ready'));
                const tx = db.transaction(storeName, 'readwrite');
                tx.objectStore(storeName).put(data, key).onsuccess = () => resolve();
            });
        }

        function loadFromIndexedDB(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error('DB not ready'));
                const tx = db.transaction(storeName, 'readonly');
                const request = tx.objectStore(storeName).get(key);
                request.onsuccess = () => resolve(request.result);
            });
        }

        // ===== ÊäòÁñäÂçÄÂ°ä =====
        function toggleSection(id) {
            const section = document.getElementById(`${id}Section`);
            if (!section) return;
            const toggle = section.previousElementSibling;
            const arrow = document.getElementById(`${id}ArrowIcon`);
            
            section.classList.toggle('show');
            if (toggle) toggle.classList.toggle('open');
        }

        // ===== Âø´ÈÄüÈ¢®Ê†ºÈ†êË®≠ =====
        const quickStyles = {
            pop_ballad: {
                genre: ['Ballad', 'Pop'],
                mood: ['Romantic', 'Melancholic', 'Bittersweet'],
                voice: 'Female vocal',
                lyricStyle: 'ÊÑèË±°Ë©©ÊÑè',
                songVibe: 'emotional, heartfelt, sincere',
                instruments: ['Piano', 'String Orchestra', 'Acoustic Guitar'],
                bpm: 'Slow tempo, 60-80 BPM',
                production: 'Polished, radio-ready'
            },
            dance_edm: {
                genre: ['EDM', 'Dance Pop', 'House'],
                mood: ['Energetic', 'Happy', 'Uplifting'],
                voice: 'Female vocal',
                lyricStyle: 'Âè£Ë™ûÂåñ',
                songVibe: 'party, fun, groovy',
                instruments: ['Synthesizer', 'Drum Machine', '808 Bass', 'Lead Synth'],
                bpm: 'Fast tempo, 120-140 BPM',
                production: 'Polished, radio-ready'
            },
            rock_band: {
                genre: ['Rock', 'Alternative Rock'],
                mood: ['Energetic', 'Passionate', 'Intense'],
                voice: 'Male vocal',
                lyricStyle: 'Áõ¥ÁôΩÊïò‰∫ã',
                songVibe: 'emotional, heartfelt, sincere',
                instruments: ['Electric Guitar', 'Bass Guitar', 'Drums'],
                bpm: 'Fast tempo, 120-140 BPM',
                production: 'Raw, live recording'
            },
            hiphop_rnb: {
                genre: ['Hip Hop', 'R&B', 'Trap'],
                mood: ['Dark', 'Passionate', 'Intense'],
                voice: 'Male vocal',
                lyricStyle: 'Âè£Ë™ûÂåñ',
                songVibe: 'indie, artistic, unique',
                instruments: ['808 Bass', 'Drum Machine', 'Synth Pads'],
                bpm: 'Medium tempo, 80-100 BPM',
                production: 'Polished, radio-ready'
            },
            folk_acoustic: {
                genre: ['Folk', 'Indie Rock'],
                mood: ['Nostalgic', 'Peaceful', 'Hopeful'],
                voice: 'Male vocal',
                lyricStyle: 'ÊïÖ‰∫ãÊÄß',
                songVibe: 'indie, artistic, unique',
                instruments: ['Acoustic Guitar', 'Harmonica', 'Violin'],
                bpm: 'Medium tempo, 80-100 BPM',
                production: 'Acoustic, unplugged'
            },
            chinese_style: {
                genre: ['Chinese Traditional', 'C-Pop'],
                mood: ['Melancholic', 'Nostalgic', 'Ethereal'],
                voice: 'Female vocal',
                lyricStyle: 'ÊÑèË±°Ë©©ÊÑè',
                songVibe: 'emotional, heartfelt, sincere',
                instruments: ['Guzheng', 'Erhu', 'Pipa', 'Flute'],
                bpm: 'Medium tempo, 80-100 BPM',
                production: 'Clean, studio quality'
            },
            kpop_jpop: {
                genre: ['K-Pop', 'J-Pop', 'Dance Pop'],
                mood: ['Energetic', 'Happy', 'Playful'],
                voice: 'Duet, male and female',
                lyricStyle: 'Âè£Ë™ûÂåñ',
                songVibe: 'radio-ready, catchy, mainstream',
                instruments: ['Synthesizer', 'Electric Guitar', 'Drums', 'Synth Bass'],
                bpm: 'Fast tempo, 120-140 BPM',
                production: 'Polished, radio-ready'
            },
            lofi_chill: {
                genre: ['Lo-Fi', 'Jazz', 'Ambient'],
                mood: ['Calm', 'Dreamy', 'Nostalgic'],
                voice: 'Female vocal',
                lyricStyle: 'ÊÑèË±°Ë©©ÊÑè',
                songVibe: 'chill, relaxed, laid-back',
                instruments: ['Rhodes', 'Drums', 'Bass Guitar', 'Synth Pads'],
                bpm: 'Slow tempo, 60-80 BPM',
                production: 'Lo-fi, vintage'
            },
            epic_cinematic: {
                genre: ['Orchestral', 'Cinematic', 'Classical'],
                mood: ['Intense', 'Dark', 'Passionate'],
                voice: 'Choir',
                lyricStyle: 'ÊÑèË±°Ë©©ÊÑè',
                songVibe: 'epic, grand, powerful',
                instruments: ['String Orchestra', 'Timpani', 'Trumpet', 'Choir'],
                bpm: 'Medium tempo, 100-120 BPM',
                production: 'Clean, studio quality'
            },
            jazz_soul: {
                genre: ['Jazz', 'Soul', 'R&B'],
                mood: ['Romantic', 'Calm', 'Passionate'],
                voice: 'Female vocal',
                lyricStyle: 'Áõ¥ÁôΩÊïò‰∫ã',
                songVibe: 'indie, artistic, unique',
                instruments: ['Piano', 'Saxophone', 'Upright Bass', 'Drums'],
                bpm: 'Medium tempo, 80-100 BPM',
                production: 'Raw, live recording'
            }
        };

        function applyQuickStyle(styleKey) {
            const style = quickStyles[styleKey];
            if (!style) return;

            // Ê∏ÖÈô§‰πãÂâçÁöÑÈÅ∏Êìá
            clearAll('genre');
            clearAll('mood');
            clearAll('instruments');

            // Ë®≠ÂÆöÈü≥Ê®ÇÈ¢®Ê†º
            style.genre.forEach(g => {
                const checkbox = document.querySelector(`#genreDropdown input[value="${g}"]`);
                if (checkbox) checkbox.checked = true;
            });
            updateMultiSelect('genre');

            // Ë®≠ÂÆöÊÉÖÊÑüÊ∞õÂúç
            style.mood.forEach(m => {
                const checkbox = document.querySelector(`#moodDropdown input[value="${m}"]`);
                if (checkbox) checkbox.checked = true;
            });
            updateMultiSelect('mood');

            // Ë®≠ÂÆöÊ®ÇÂô®
            style.instruments.forEach(i => {
                const checkbox = document.querySelector(`input[value="${i}"]`);
                if (checkbox) checkbox.checked = true;
            });
            updateMultiSelect('instruments');

            // Ë®≠ÂÆö‰∫∫ËÅ≤È°ûÂûã
            document.getElementById('voice').value = style.voice;

            // Ë®≠ÂÆöÊ≠åË©ûÈ¢®Ê†º
            document.getElementById('lyricStyle').value = style.lyricStyle;

            // Ë®≠ÂÆöÊ≠åÊõ≤Ê∞õÂúç
            const songVibeEl = document.getElementById('songVibe');
            if (songVibeEl) songVibeEl.value = style.songVibe;

            // Ë®≠ÂÆöÈö±ËóèÁöÑÈÄ≤ÈöéÈÅ∏È†Ö
            document.getElementById('bpm').value = style.bpm;
            document.getElementById('production').value = style.production;

            // Êõ¥Êñ∞ÈÄ≤ÈöéÈÅ∏È†ÖÁöÑ‰∏ãÊãâÈÅ∏ÂñÆÈ°ØÁ§∫
            const bpmSelect = document.getElementById('bpmSelect');
            const productionSelect = document.getElementById('productionSelect');
            if (bpmSelect) bpmSelect.value = style.bpm;
            if (productionSelect) productionSelect.value = style.production;

            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.quick-style-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // ÂÑ≤Â≠òÁãÄÊÖã
            saveFormState();
            updatePromptSummary();
        }

        // ===== Ê≠åÊõ≤È°ûÂûãÂàáÊèõ =====
        document.querySelectorAll('input[name="songType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const musicLyricsSection = document.getElementById('musicLyricsSection');
                const musicLyricsToggle = musicLyricsSection ? musicLyricsSection.previousElementSibling : null;
                // Á¥îÈü≥Ê®ÇÊ®°ÂºèÊôÇÈö±Ëóè‰∫∫ËÅ≤Áõ∏ÈóúÈÅ∏È†Ö
                const voiceGroup = document.getElementById('voice')?.closest('.form-group');
                const lyricStyleGroup = document.getElementById('lyricStyle')?.closest('.form-group');
                if (this.value === 'instrumental') {
                    if (voiceGroup) voiceGroup.style.opacity = '0.5';
                    if (lyricStyleGroup) lyricStyleGroup.style.opacity = '0.5';
                } else {
                    if (voiceGroup) voiceGroup.style.opacity = '1';
                    if (lyricStyleGroup) lyricStyleGroup.style.opacity = '1';
                }
                saveFormState();
            });
        });

        // ===== ÁîüÊàêÊ®°ÂºèÂàáÊèõ =====
        function toggleAlbumSettings() {
            const mode = document.querySelector('input[name="generateMode"]:checked').value;
            const singleSettings = document.getElementById('singleSettings');
            const albumSettings = document.getElementById('albumSettings');
            
            if (mode === 'album') {
                singleSettings.style.display = 'none';
                albumSettings.classList.add('show');
            } else {
                singleSettings.style.display = '';
                albumSettings.classList.remove('show');
            }
            saveFormState();
        }

        function updateAlbumCount() {
            const count = document.getElementById('albumCount').value;
            document.getElementById('albumCountValue').textContent = count + ' È¶ñ';
            saveFormState();
        }

        // ===== Â§öÈÅ∏‰∏ãÊãâÂºè =====
        function toggleDropdown(type) {
            const dropdown = document.getElementById(`${type}Dropdown`);
            const arrow = document.getElementById(`${type}Arrow`);
            const display = dropdown.previousElementSibling;
            const isOpen = dropdown.classList.contains('show');
            
            document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.multi-select-arrow').forEach(a => a.classList.remove('open'));
            document.querySelectorAll('.multi-select-display').forEach(d => d.classList.remove('active'));
            
            if (!isOpen) {
                dropdown.classList.add('show');
                arrow.classList.add('open');
                display.classList.add('active');
            }
        }

        function updateMultiSelect(type) {
            const container = document.getElementById(`${type}Container`);
            const selectedDiv = document.getElementById(`${type}Selected`);
            const countSpan = document.getElementById(`${type}Count`);
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            const selectedValues = [];
            
            checkboxes.forEach(cb => {
                if (cb.checked) selectedValues.push(cb.value);
                cb.closest('.dropdown-option')?.classList.toggle('selected', cb.checked);
            });
            
            if (selectedValues.length === 0) {
                selectedDiv.innerHTML = `<span class="multi-select-placeholder">ÈªûÊìäÈÅ∏Êìá...</span>`;
                if (countSpan) countSpan.textContent = '';
            } else {
                selectedDiv.innerHTML = selectedValues.map(v => 
                    `<span class="selected-tag">${v}<span class="remove-tag" onclick="event.stopPropagation(); removeSelection('${type}', '${v}')">√ó</span></span>`
                ).join('');
                if (countSpan) countSpan.textContent = `Â∑≤ÈÅ∏ ${selectedValues.length}`;
            }
            saveFormState();
        }

        function removeSelection(type, value) {
            const container = document.getElementById(`${type}Container`);
            const checkbox = container.querySelector(`input[value="${value}"]`);
            if (checkbox) {
                checkbox.checked = false;
                updateMultiSelect(type);
            }
        }

        function clearAll(type) {
            const container = document.getElementById(`${type}Container`);
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateMultiSelect(type);
        }

        function getSelectedValues(type) {
            const container = document.getElementById(`${type}Container`);
            return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        function setMultiSelectValues(type, values = []) {
            const container = document.getElementById(`${type}Container`);
            if (!container) return;
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = values.includes(cb.value);
            });
            updateMultiSelect(type);
        }

        // ÈóúÈñâ‰∏ãÊãâÈÅ∏ÂñÆ
        document.addEventListener('click', e => {
            if (!e.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
                document.querySelectorAll('.multi-select-arrow').forEach(a => a.classList.remove('open'));
                document.querySelectorAll('.multi-select-display').forEach(d => d.classList.remove('active'));
            }
        });

        // ===== Ë°®ÂñÆÁãÄÊÖãÁÆ°ÁêÜ =====
        async function saveFormState() {
            const state = {
                theme: document.getElementById('theme').value,
                songType: document.querySelector('input[name="songType"]:checked')?.value,
                generateMode: document.querySelector('input[name="generateMode"]:checked')?.value,
                genre: getSelectedValues('genre'),
                mood: getSelectedValues('mood'),
                instruments: getSelectedValues('instruments'),
                language: getSelectedValues('language'),
                bpm: document.getElementById('bpm').value,
                era: document.getElementById('era').value,
                key: document.getElementById('key').value,
                region: document.getElementById('region').value,
                production: document.getElementById('production').value,
                technique: document.getElementById('technique').value,
                voice: document.getElementById('voice').value,
                vocalEffect: document.getElementById('vocalEffect').value,
                structure: document.getElementById('structure').value,
                lyricStyle: document.getElementById('lyricStyle').value,
                duration: document.getElementById('duration').value,
                count: document.getElementById('count').value,
                creativity: document.getElementById('creativity').value,
                albumCount: document.getElementById('albumCount').value,
                albumDuration: document.getElementById('albumDuration').value,
                albumCreativity: document.getElementById('albumCreativity').value,
                requirements: document.getElementById('requirements').value
            };
            try {
                await saveToIndexedDB(STORE_NAME, 'formState', state);
            } catch (e) {
                console.warn('Save state failed:', e);
            }
            updatePromptSummary();
        }

        async function loadFormState() {
            try {
                const state = await loadFromIndexedDB(STORE_NAME, 'formState');
                if (!state) return;

                if (state.theme) document.getElementById('theme').value = state.theme;
                if (state.songType) {
                    const radio = document.querySelector(`input[name="songType"][value="${state.songType}"]`);
                    if (radio) { radio.checked = true; radio.dispatchEvent(new Event('change')); }
                }
                if (state.generateMode) {
                    const radio = document.querySelector(`input[name="generateMode"][value="${state.generateMode}"]`);
                    if (radio) { radio.checked = true; toggleAlbumSettings(); }
                }

                ['genre', 'mood', 'instruments', 'language'].forEach(type => {
                    if (state[type]) {
                        // Áõ∏ÂÆπËàäÁâàÊú¨ÁöÑÂ≠ó‰∏≤Ê†ºÂºè
                        const values = Array.isArray(state[type]) ? state[type] : [state[type]];
                        values.forEach(val => {
                            const cb = document.querySelector(`#${type}Container input[value="${val}"]`);
                            if (cb) cb.checked = true;
                        });
                        updateMultiSelect(type);
                    }
                });

                ['bpm', 'era', 'key', 'region', 'production', 'technique', 'voice', 'vocalEffect', 'structure', 'lyricStyle', 'duration', 'count', 'creativity', 'albumDuration', 'albumCreativity', 'requirements'].forEach(id => {
                    if (state[id]) document.getElementById(id).value = state[id];
                });

                if (state.albumCount) {
                    document.getElementById('albumCount').value = state.albumCount;
                    updateAlbumCount();
                }
                updatePromptSummary();
            } catch (e) {
                console.warn('Load state failed:', e);
            }
        }

        // ===== API ÁÆ°ÁêÜ =====
        function openApiModal() { document.getElementById('apiModal').classList.add('show'); }
        function closeApiModal() { document.getElementById('apiModal').classList.remove('show'); }

        async function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) { alert('Ë´ãËº∏ÂÖ• API ÈáëÈë∞'); return; }
            try {
                await saveToIndexedDB(API_KEY_STORE, 'apiKey', key);
                alert('‚úÖ API ÈáëÈë∞Â∑≤ÂÑ≤Â≠ò!');
                closeApiModal();
            } catch (e) {
                alert('ÂÑ≤Â≠òÂ§±Êïó: ' + e.message);
            }
        }

        async function getApiKey() {
            try { return await loadFromIndexedDB(API_KEY_STORE, 'apiKey'); }
            catch { return null; }
        }

        // ===== Ë®≠ÂÆöËàáÊëòË¶Å =====
        function getCurrentSettings() {
            const isInstrumental = document.querySelector('input[name="songType"]:checked').value === 'instrumental';
            const generateMode = document.querySelector('input[name="generateMode"]:checked').value;
            return {
                theme: document.getElementById('theme').value.trim(),
                isInstrumental,
                generateMode,
                genre: getSelectedValues('genre'),
                mood: getSelectedValues('mood'),
                instruments: getSelectedValues('instruments'),
                language: getSelectedValues('language'),
                bpm: document.getElementById('bpm').value,
                era: document.getElementById('era').value,
                key: document.getElementById('key').value,
                region: document.getElementById('region').value,
                production: document.getElementById('production').value,
                technique: document.getElementById('technique').value,
                voice: document.getElementById('voice').value,
                vocalEffect: document.getElementById('vocalEffect').value,
                structure: document.getElementById('structure').value,
                lyricStyle: document.getElementById('lyricStyle').value,
                songVibe: document.getElementById('songVibe')?.value || '',
                duration: document.getElementById('duration').value,
                count: document.getElementById('count').value,
                albumCount: document.getElementById('albumCount').value,
                albumDuration: document.getElementById('albumDuration').value,
                albumCreativity: document.getElementById('albumCreativity').value,
                creativity: document.getElementById('creativity').value,
                requirements: document.getElementById('requirements').value
            };
        }

        function summarizeList(arr) {
            if (!arr || arr.length === 0) return 'Ëá™Âãï';
            if (arr.length <= 3) return arr.join('„ÄÅ');
            return `${arr.slice(0, 3).join('„ÄÅ')} Á≠â(${arr.length})`;
        }

        function updatePromptSummary() {
            const s = getCurrentSettings();
            const lang = summarizeList(s.language);
            const style = [summarizeList(s.genre), summarizeList(s.mood)].filter(Boolean).join(' ¬∑ ');
            const inst = summarizeList(s.instruments);
            const meta = [s.bpm || 'Ëá™Âãï', s.era || 'Ëá™Âãï', s.key || 'Ëá™Âãï'].join(' / ');
            document.getElementById('summaryMode').textContent = `${s.generateMode === 'album' ? 'Â∞àËºØ' : 'ÂñÆÊõ≤'} ¬∑ ${s.isInstrumental ? 'Á¥îÈü≥Ê®Ç' : '‰∫∫ËÅ≤'}`;
            document.getElementById('summaryLang').textContent = lang || 'Ëá™Âãï';
            document.getElementById('summaryStyle').textContent = style || 'Ëá™Âãï';
            document.getElementById('summaryInstruments').textContent = inst || 'Ëá™Âãï';
            document.getElementById('summaryMeta').textContent = meta;
        }

        function renderPresetOptions() {
            const select = document.getElementById('presetSelect');
            if (!select) return;
            select.innerHTML = `<option value="">ÈÅ∏ÊìáÂ∏∏Áî®È†êË®≠</option>` + PRESETS.map((p, idx) => 
                `<option value="${idx}">${p.name}</option>`
            ).join('');
        }

        function applyPreset() {
            const select = document.getElementById('presetSelect');
            const idx = select.value;
            if (idx === '') return;
            const preset = PRESETS[idx];
            if (!preset) return;
            if (preset.theme) document.getElementById('theme').value = preset.theme;
            if (preset.genre) setMultiSelectValues('genre', preset.genre);
            if (preset.mood) setMultiSelectValues('mood', preset.mood);
            if (preset.instruments) setMultiSelectValues('instruments', preset.instruments);
            if (preset.language) setMultiSelectValues('language', preset.language);
            if (preset.structure) document.getElementById('structure').value = preset.structure;
            if (preset.bpm) document.getElementById('bpm').value = preset.bpm;
            if (preset.voice) document.getElementById('voice').value = preset.voice;
            if (preset.vocalEffect) document.getElementById('vocalEffect').value = preset.vocalEffect;
            if (preset.production) document.getElementById('production').value = preset.production;
            saveFormState();
            updatePromptSummary();
            alert(`Â∑≤Â•óÁî®È†êË®≠Ôºö„Äå${preset.name}„Äç`);
        }

        // ===== È¢®Ê†ºÊèêÁ§∫Ë©ûÁîüÊàê =====
        function shuffleArray(arr) {
            const newArr = [...arr];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        }

        function generateUniqueStylePrompts(count, settings) {
            const prompts = [];
            
            for (let i = 0; i < count; i++) {
                const parts = [];
                
                if (settings.genre.length > 0) {
                    const shuffled = shuffleArray(settings.genre);
                    parts.push(shuffled.slice(0, Math.min(2, shuffled.length)).join(', '));
                }
                
                if (settings.mood.length > 0) {
                    const shuffled = shuffleArray(settings.mood);
                    parts.push(shuffled.slice(0, Math.min(2, shuffled.length)).join(', '));
                }
                
                if (settings.instruments.length > 0) {
                    const shuffled = shuffleArray(settings.instruments);
                    parts.push(shuffled.slice(0, Math.min(3, shuffled.length)).join(', '));
                }
                
                if (settings.bpm) parts.push(settings.bpm);
                if (settings.era) parts.push(settings.era);
                if (settings.key) parts.push(settings.key);
                if (settings.region) parts.push(settings.region);
                if (settings.production) parts.push(settings.production);
                if (settings.vocalEffect && !settings.isInstrumental) parts.push(settings.vocalEffect);
                
                if (settings.isInstrumental) {
                    parts.push('Instrumental');
                } else {
                    parts.push(settings.voice);
                }
                
                const modifiers = ['Emotional', 'Melodic', 'Groovy', 'Atmospheric', 'Powerful', 'Soft', 'Energetic', 'Cinematic', 'Catchy', 'Anthemic'];
                if (Math.random() > 0.4) {
                    parts.push(modifiers[Math.floor(Math.random() * modifiers.length)]);
                }
                
                prompts.push(shuffleArray(parts).join(', '));
            }
            
            return prompts;
        }

        // ===== Ê≠åË©ûÁîüÊàê =====
        async function generateLyrics() {
            const theme = document.getElementById('theme').value.trim();
            if (!theme) { alert('Ë´ãËº∏ÂÖ•Ê≠åÊõ≤‰∏ªÈ°å'); return; }

            const apiKey = await getApiKey();
            if (!apiKey) { alert('Ë´ãÂÖàË®≠ÂÆö API ÈáëÈë∞'); openApiModal(); return; }

            const isInstrumental = document.querySelector('input[name="songType"]:checked').value === 'instrumental';
            const generateMode = document.querySelector('input[name="generateMode"]:checked').value;
            
            const isAlbumMode = generateMode === 'album';
            const count = isAlbumMode ? parseInt(document.getElementById('albumCount').value) : parseInt(document.getElementById('count').value);
            const creativity = parseFloat(isAlbumMode ? document.getElementById('albumCreativity').value : document.getElementById('creativity').value);
            const duration = isAlbumMode ? document.getElementById('albumDuration').value : document.getElementById('duration').value;
            
            const settings = getCurrentSettings();
            settings.theme = theme;
            settings.isInstrumental = isInstrumental;
            settings.generateMode = generateMode;
            settings.count = count;
            settings.duration = duration;
            settings.creativity = creativity;

            document.getElementById('generateBtn').disabled = true;
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultSection').classList.remove('show');

            const stylePrompts = generateUniqueStylePrompts(count, settings);

            let prompt;
            if (isAlbumMode) {
                // Â∞àËºØÊ®°ÂºèÊèêÁ§∫Ë©û
                if (isInstrumental) {
                    // Â∞àËºØÁ¥îÈü≥Ê®ÇÁµêÊßãËÆäÂåñ
                    const albumInstrumentalStructures = [
                        '[Ambient Intro] ‚Üí [Theme] ‚Üí [Development] ‚Üí [Climax] ‚Üí [Resolution]',
                        '[Build Up] ‚Üí [Drop] ‚Üí [Breakdown] ‚Üí [Drop 2] ‚Üí [Outro]',
                        '[Soundscape] ‚Üí [Layer Build] ‚Üí [Peak] ‚Üí [Deconstruction] ‚Üí [Fade]',
                        '[Main Loop] ‚Üí [Variation A] ‚Üí [Variation B] ‚Üí [Combined] ‚Üí [Outro]',
                        '[Overture] ‚Üí [Exposition] ‚Üí [Development] ‚Üí [Recapitulation]',
                        '[Motif] ‚Üí [Layered Build] ‚Üí [Noise Peak] ‚Üí [Decay]',
                        '[Intro Hook] ‚Üí [Verse] ‚Üí [Drop] ‚Üí [Bridge] ‚Üí [Final Drop]',
                        '[Sparse Intro] ‚Üí [Groove] ‚Üí [Break] ‚Üí [Full Arrangement] ‚Üí [Outro]'
                    ];
                    
                    prompt = `‰Ω†ÊòØÂ∞àÊ•≠ÈÖçÊ®ÇË£Ω‰Ωú‰∫∫/ÈõªÂ≠êÈü≥Ê®ÇÂÆ∂ÔºåË´ãË£Ω‰Ωú‰∏ÄÂºµÊ¶ÇÂøµÊÄßÁ¥îÈü≥Ê®ÇÂ∞àËºØ„ÄÇ

„ÄêÂ∞àËºØ‰ºÅÂäÉ„Äë
- Â∞àËºØ‰∏ªÈ°å/Ê¶ÇÂøµÔºö${theme}
- Êõ≤È¢®ÂÆö‰ΩçÔºö${settings.genre.join(', ') || 'Ëá™Âãï'}
- ÊÉÖÊÑü‰∏ªËª∏Ôºö${settings.mood.join(', ') || 'Ëá™Âãï'}
- ‰∏ªË¶ÅÊ®ÇÂô®/Èü≥Ëâ≤Ôºö${settings.instruments.join(', ') || 'Ëá™Âãï'}
- ÁØÄÂ•èÁØÑÂúçÔºö${settings.bpm || 'Ëá™Âãï'}
- Âπ¥‰ª£ÊÑüÔºö${settings.era || 'Ëá™Âãï'}
- Ë™øÊÄßÔºö${settings.key || 'Ëá™Âãï'}
- Âú∞ÂüüÈ¢®Ê†ºÔºö${settings.region || 'Ëá™Âãï'}
- Ë£Ω‰ΩúË≥™ÊÑüÔºö${settings.production || 'Ëá™Âãï'}
- ÂñÆÊõ≤ÊôÇÈï∑Ôºö${duration}
${settings.requirements ? `- ÁâπÊÆäË¶ÅÊ±ÇÔºö${settings.requirements}` : ''}

„ÄêÂ∞àËºØÁµêÊßãË¶èÂäÉ„Äë
1. **Êõ≤Â∫èË®≠Ë®à**Ôºö
   - ÈñãÂ†¥Êõ≤ÔºöÂª∫Á´ãÂ∞àËºØÊ∞õÂúç
   - ‰∏≠ÊÆµÔºöÁôºÂ±ïËÆäÂåñÔºåÁØÄÂ•èÂø´ÊÖ¢‰∫§ÈåØ
   - ÁµêÂ∞æÔºöÊî∂ÊùüÊàñÈñãÊîæÂºèÁµêÂ±Ä

2. **ÊØèÈ¶ñÁµêÊßãÂàÜÈÖç**Ôºö
${Array.from({length: count}, (_, i) => {
    const struct = albumInstrumentalStructures[i % albumInstrumentalStructures.length];
    return `Á¨¨ ${i + 1} È¶ñÔºö${struct}`;
}).join('\n')}

„ÄêË£Ω‰ΩúË¶èÁØÑ„Äë
1. **ÁµêÊßãÊ®ôÁ±§**Ôºö‰ΩøÁî® Suno Ê®ôÁ±§Ôºà[Intro], [Build Up], [Drop], [Breakdown], [Bridge], [Outro] Á≠âÔºâ

2. **ÊØèÊÆµÊèèËø∞ÈúÄÂåÖÂê´**Ôºö
   - ËÉΩÈáèÁ≠âÁ¥ö (1-10)
   - Lead ‰∏ªÂ∞éÊ®ÇÂô®
   - Pad/Ambient Â¢äÂ∫ïÈü≥Ëâ≤
   - Rhythm ÁØÄÂ•èÁµÑ
   - FX ÁâπÊÆäÊïàÊûú
   - ÂãïÊÖãËµ∞ÂêëÔºàÊº∏Âº∑/Êº∏Âº±/Á™ÅËÆäÔºâ

3. **Èü≥Ê®ÇÈÄ£Ë≤´ÊÄß**Ôºö
   - Â∞àËºØÂèØÊúâË≤´Á©øÁöÑÈü≥Ëâ≤‰∏ªÈ°åÔºàMotifÔºâ
   - Áõ∏ÈÑ∞Êõ≤ÁõÆÂèØÁî®Áõ∏‰ººÂÖÉÁ¥†ÈÅéÊ∏°
   - BPM ÂèØÊúâÊº∏ÈÄ≤ËÆäÂåñ

4. **ÊØèÈ¶ñÊ≠åÁöÑÁç®ÁâπÊÄß**Ôºö
   - ‰∏çÂêåÁöÑ‰∏ªÂ∞éÊ®ÇÂô®
   - ‰∏çÂêåÁöÑÁØÄÂ•èÂûãÊÖã
   - ‰∏çÂêåÁöÑÊÉÖÊÑüÂºßÁ∑ö

Ë´ãÁîüÊàê‰∏ÄÂºµ ${count} È¶ñÊ≠åÁöÑÁ¥îÈü≥Ê®ÇÂ∞àËºØÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö

„ÄêÂ∞àËºØÂêçÁ®±„ÄëÔºàÊúâËóùË°ìÊÑüÁöÑÂ∞àËºØÂêçÔºâ
„ÄêÂ∞àËºØÊ¶ÇÂøµ„ÄëÔºà1-2 Âè•ÊèèËø∞Ôºâ
„ÄêÊï¥È´îÈü≥Ëâ≤Ë™øÊÄß„ÄëÔºàË≤´Á©øÂ∞àËºØÁöÑËÅ≤Èü≥ÁâπËâ≤Ôºâ

=== Á¨¨ 1 È¶ñ ===
„ÄêÊõ≤Âêç„ÄëÔºàÂØåÊúâÊÑèË±°ÁöÑÂêçÁ®±Ôºâ
„ÄêËßíËâ≤ÂÆö‰Ωç„ÄëÔºàÂú®Â∞àËºØ‰∏≠ÁöÑ‰ΩúÁî®Ôºâ
„ÄêÁµêÊßãÊèèËø∞„Äë
ÔºàÊØèÊÆµÁî®Ê®ôÁ±§Ê®ôÁ§∫ÔºåÂåÖÂê´Ë©≥Á¥∞ÁöÑÈü≥Ëâ≤/ÂãïÊÖãÊèèËø∞Ôºâ

=== Á¨¨ 2 È¶ñ ===
...‰ª•Ê≠§È°ûÊé®

ÊØèÈ¶ñÊõ≤ÁõÆË¶ÅÊúâÁç®ÁâπÁöÑËÅ≤Èü≥Ë®≠Ë®àÂíåÊÉÖÊÑüËµ∞ÂêëÔºå‰ΩÜÊï¥È´îÂΩ¢ÊàêÂÆåÊï¥ÁöÑËÅÜËÅΩÊóÖÁ®ã„ÄÇ`;
                } else {
                    // Â∞àËºØÊõ≤ÁõÆÁµêÊßãÂ§öÊ®£ÂåñÊ®°Êùø
                    const albumStructures = [
                        '[Intro] ‚Üí [Verse 1] ‚Üí [Pre-Chorus] ‚Üí [Chorus] ‚Üí [Verse 2] ‚Üí [Chorus] ‚Üí [Bridge] ‚Üí [Final Chorus] ‚Üí [Outro]',
                        '[Verse 1] ‚Üí [Chorus] ‚Üí [Verse 2] ‚Üí [Chorus] ‚Üí [Verse 3] ‚Üí [Double Chorus] ‚Üí [Outro]',
                        '[Hook] ‚Üí [Verse 1] ‚Üí [Hook] ‚Üí [Verse 2] ‚Üí [Bridge] ‚Üí [Hook x2]',
                        '[Intro] ‚Üí [Verse 1] ‚Üí [Verse 2] ‚Üí [Lift] ‚Üí [Chorus] ‚Üí [Verse 3] ‚Üí [Chorus] ‚Üí [Breakdown] ‚Üí [Climax Chorus]',
                        '[Soft Intro] ‚Üí [Verse 1] ‚Üí [Verse 2] ‚Üí [Pre-Chorus] ‚Üí [Chorus] ‚Üí [Interlude] ‚Üí [Verse 3] ‚Üí [Emotional Bridge] ‚Üí [Final Chorus]',
                        '[A Section] ‚Üí [A‚Ä≤ Section] ‚Üí [B Section] ‚Üí [A‚Ä≥ Section] ‚Üí [Coda]',
                        '[Intro Hook] ‚Üí [Verse] ‚Üí [Pre-Chorus] ‚Üí [Drop/Chorus] ‚Üí [Post-Chorus] ‚Üí [Verse 2] ‚Üí [Drop/Chorus] ‚Üí [Bridge] ‚Üí [Final Drop]',
                        '[Verse 1] ‚Üí [Chorus] ‚Üí [Verse 2] ‚Üí [Chorus] ‚Üí [Breakdown] ‚Üí [Build] ‚Üí [Chorus with Ad-libs] ‚Üí [Outro]'
                    ];
                    
                    prompt = `‰Ω†ÊòØÈáëÊõ≤ÁçéÁ≠âÁ¥öÁöÑÂ∞àÊ•≠Ë©ûÊõ≤Ââµ‰Ωú‰∫∫ÔºåË´ã‰ª•Ê¶ÇÂøµÂ∞àËºØÁöÑË¶èÊ†ºÂâµ‰Ωú‰∏ÄÂºµÂÆåÊï¥Â∞àËºØ„ÄÇ

„ÄêÂ∞àËºØ‰ºÅÂäÉ„Äë
- Â∞àËºØ‰∏ªÈ°å/Ê¶ÇÂøµÔºö${theme}
- Êõ≤È¢®ÂÆö‰ΩçÔºö${settings.genre.join(', ') || 'Ëá™Âãï'}
- ÊÉÖÊÑü‰∏ªËª∏Ôºö${settings.mood.join(', ') || 'Ëá™Âãï'}
- ÈÖçÂô®È¢®Ê†ºÔºö${settings.instruments.join(', ') || 'Ëá™Âãï'}
- ÁØÄÂ•èÁØÑÂúçÔºö${settings.bpm || 'Ëá™Âãï'}
- Âπ¥‰ª£ÊÑüÔºö${settings.era || 'Ëá™Âãï'}
- Ë™øÊÄßÔºö${settings.key || 'Ëá™Âãï'}
- Âú∞ÂüüËâ≤ÂΩ©Ôºö${settings.region || 'Ëá™Âãï'}
- Ë£Ω‰ΩúË≥™ÊÑüÔºö${settings.production || 'Ëá™Âãï'}
- ÊºîÂî±ÂûãÊÖãÔºö${settings.voice}
- Ë™ûË®ÄÔºö${settings.language.join('„ÄÅ') || 'ÁπÅÈ´î‰∏≠Êñá'}
- ‰∫∫ËÅ≤ÊïàÊûúÔºö${settings.vocalEffect || 'Ëá™ÁÑ∂'}
- Ê≠åË©ûÈ¢®Ê†ºÔºö${settings.lyricStyle || 'Ëá™Âãï'}
- Ê≠åÊõ≤Ê∞õÂúçÔºö${settings.songVibe || 'Ëá™Âãï'}
- ÂñÆÊõ≤ÊôÇÈï∑Ôºö${duration}
${settings.requirements ? `- ÁâπÊÆäË¶ÅÊ±ÇÔºö${settings.requirements}` : ''}

„ÄêÂ∞àËºØÊï¥È´îË¶èÂäÉÂéüÂâá„Äë
1. **Êõ≤Â∫èÈÇèËºØ**ÔºöÂ∞àËºØË¶ÅÊúâ„ÄåÊóÖÁ®ãÊÑü„Äç
   - Á¨¨ 1 È¶ñÔºöÈñãÂ†¥Êõ≤ÔºåÂª∫Á´ã‰∏ªÈ°å/Ê∞õÂúç
   - ‰∏≠ÈñìÔºöÁôºÂ±ï„ÄÅËÆäÂåñ„ÄÅÈ´òÊΩÆ
   - ÊúÄÂæå‰∏ÄÈ¶ñÔºöÁµêÂ∞æ/ÊòáËèØ/ÂõûÊ≠∏

2. **È¢®Ê†ºÂ§öÊ®£ÊÄß**Ôºö
   - ÊØèÈ¶ñÊ≠å‰ΩøÁî®„Äê‰∏çÂêåÁöÑÊõ≤ÂºèÁµêÊßã„ÄëÔºà‰∏ãÊñπÊúÉÁÇ∫ÊØèÈ¶ñÂàÜÈÖçÔºâ
   - ÁØÄÂ•èÂø´ÊÖ¢‰∫§ÈåØÔºåÈÅøÂÖçÈÄ£Á∫åÁõ∏‰ººÁöÑÊõ≤È¢®
   - ÂèØÂåÖÂê´Ôºö‰∏ªÊâìÊ≠å„ÄÅÊäíÊÉÖÊõ≤„ÄÅÁØÄÂ•èÊ≠å„ÄÅÂØ¶È©óÊõ≤„ÄÅInterlude

3. **Ê≠åË©ûÈÄ£Ë≤´ÊÄß**Ôºö
   - ÂèØ‰ΩøÁî®Ë≤´Á©øÂÖ®ËºØÁöÑÊÑèË±°/Èö±Âñª
   - Ê≠åÂêçÂèØ‰ª•ÊúâÂëºÊáâÊàñÈóúËÅØ
   - ÂâçÂæåÊõ≤ÁõÆÂèØ‰ª•ÊúâÊïÖ‰∫ã‰∏äÁöÑÂª∂Á∫å

„ÄêÂêÑÊõ≤ÁõÆÁµêÊßãÂàÜÈÖç„Äë
${Array.from({length: count}, (_, i) => {
    const struct = albumStructures[i % albumStructures.length];
    return `Á¨¨ ${i + 1} È¶ñÔºö${struct}`;
}).join('\n')}

„ÄêÂ∞àÊ•≠ÂØ´Ë©ûË¶èÁØÑ„Äë
1. „ÄêÁµêÊßãÂü∑Ë°å„Äë
   - ÊØèÈ¶ñÊ≠åÊåâÁÖß‰∏äÊñπÂàÜÈÖçÁöÑÁµêÊßãÊ®ôÁ±§Ââµ‰Ωú
   - Áî® [Ê®ôÁ±§] Ê®ôÁ§∫ÊØèÂÄãÊÆµËêΩ
   - ÂêÑÊÆµËêΩËÅ∑Ë≤¨ÊòéÁ¢∫ÔºöVerse Êïò‰∫ã„ÄÅPre-Chorus Â†ÜÁñä„ÄÅChorus ÁàÜÁôº„ÄÅBridge ËΩâÊäò

2. „ÄêÊóãÂæãÊÄß„Äë
   - ÊØèË°å 5-15 Â≠óÔºåÈÅ©ÂêàÊºîÂî±
   - Chorus ÂøÖÈ†àÊúâ‰∏ÄÂÄãË®òÊÜ∂Èªû Hook
   - Ê≥®ÊÑèÂ≠óÊï∏Â∞çÁ®±Ôºå‰æøÊñºÊóãÂæãË®≠Ë®à

3. „ÄêÊäºÈüªÊäÄÂ∑ß„Äë
   - ÊØèÈ¶ñÂèØÁî®‰∏çÂêåÊäºÈüªÊ®°ÂºèÔºàAABB / ABAB / ABBA / Ëá™Áî±ÈüªÔºâ
   - ÂâØÊ≠åÊäºÈüªË¶ÅÂ∑•Êï¥ÔºåVerse ÂèØËá™Áî±
   - ÂñÑÁî®ËøëÈüª„ÄÅË´ßÈü≥Èüª

4. „ÄêÊÑèË±°Á≥ªÁµ±„Äë
   - ÊØèÈ¶ñÊ≠åÂª∫Á´ãÁç®ÁâπÁöÑÊÑèË±°
   - Áî®ÂÖ∑È´îÁï´Èù¢Âèñ‰ª£ÊäΩË±°ÂΩ¢ÂÆπ
   - ‰∫îÊÑüÊèèÂØ´ÔºöË¶ñ„ÄÅËÅΩ„ÄÅËß∏„ÄÅÂóÖ„ÄÅÂë≥

5. „ÄêÊÉÖÊÑüÂ±§Ê¨°„Äë
   - ÊØèÈ¶ñÊ≠åÂÖßÈÉ®Ë¶ÅÊúâËµ∑‰ºè
   - Chorus Ëã•ÈáçË§áÔºåÊ≠åË©ûÂèØÂæÆË™øÂèçÊò†ÊÉÖÊÑüÈÅûÈÄ≤

Ë´ãÁîüÊàê‰∏ÄÂºµ ${count} È¶ñÊ≠åÁöÑÂÆåÊï¥Â∞àËºØÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö

„ÄêÂ∞àËºØÂêçÁ®±„ÄëÔºàÂèñ‰∏ÄÂÄãÊúâËóùË°ìÊÑüÁöÑÂ∞àËºØÂêçÔºâ
„ÄêÂ∞àËºØÊ¶ÇÂøµÁ∞°Ëø∞„ÄëÔºà1-2 Âè•Ë™™ÊòéÂ∞àËºØÊ¶ÇÂøµÔºâ

=== Á¨¨ 1 È¶ñ ===
„ÄêÊ≠åÂêç„ÄëÔºàÊúâÊÑèÁæ©‰∏îÊúâË®òÊÜ∂ÈªûÁöÑÊ≠åÂêçÔºâ
„ÄêÊõ≤È¢®ÂÆö‰Ωç„ÄëÔºàÈÄôÈ¶ñÊ≠åÂú®Â∞àËºØ‰∏≠ÁöÑËßíËâ≤Ôºâ
„ÄêÊ≠åË©û„Äë
ÔºàÊåâÁÖßÂàÜÈÖçÁöÑÁµêÊßãÊ®ôÁ±§Ââµ‰ΩúÔºâ

=== Á¨¨ 2 È¶ñ ===
...‰ª•Ê≠§È°ûÊé®

ÊØèÈ¶ñÊ≠åË¶ÅÊúâÁç®ÁâπÁöÑÈ¢®Ê†º„ÄÅÊïò‰∫ãËßíÂ∫¶ÂíåÊÉÖÊÑüÂ±§Ê¨°Ôºå‰ΩÜÊï¥È´îË¶ÅÁ¨¶ÂêàÂ∞àËºØÊ¶ÇÂøµÔºåÂΩ¢ÊàêÂÆåÊï¥ÁöÑÈü≥Ê®ÇÊóÖÁ®ã„ÄÇ`;
                }
            } else {
                // ÂñÆÊõ≤Ê®°ÂºèÊèêÁ§∫Ë©û
                if (isInstrumental) {
                    // Á¥îÈü≥Ê®ÇÁµêÊßãÊ®°Êùø
                    const instrumentalStructures = [
                        {
                            name: 'ÈõªÂΩ±ÈÖçÊ®ÇÂûã',
                            tags: '[Ambient Intro] ‚Üí [Theme Statement] ‚Üí [Development] ‚Üí [Tension Build] ‚Üí [Climax] ‚Üí [Resolution] ‚Üí [Theme Reprise] ‚Üí [Fade Out]'
                        },
                        {
                            name: 'EDM/ÈõªÂ≠êËàûÊõ≤',
                            tags: '[Intro] ‚Üí [Build Up] ‚Üí [Drop 1] ‚Üí [Breakdown] ‚Üí [Build Up 2] ‚Üí [Drop 2 (ËÆäÂ•è)] ‚Üí [Outro]'
                        },
                        {
                            name: 'Êñ∞‰∏ñÁ¥Ä/Ê∞õÂúç',
                            tags: '[Soundscape Intro] ‚Üí [Layer 1: Pad] ‚Üí [Layer 2: Melody] ‚Üí [Layer 3: Rhythm] ‚Üí [Peak] ‚Üí [Deconstruction] ‚Üí [Minimal Outro]'
                        },
                        {
                            name: 'Lo-Fi/Chill',
                            tags: '[Vinyl Crackle Intro] ‚Üí [Main Loop] ‚Üí [Variation A] ‚Üí [Variation B] ‚Üí [Return to Main] ‚Üí [Outro with Fade]'
                        },
                        {
                            name: 'Âè§ÂÖ∏/ÁÆ°Âº¶',
                            tags: '[Overture] ‚Üí [Exposition] ‚Üí [Development] ‚Üí [Recapitulation] ‚Üí [Coda]'
                        },
                        {
                            name: 'ÂæåÊêñ/ÂØ¶È©ó',
                            tags: '[Drone Intro] ‚Üí [Motif Introduction] ‚Üí [Layered Build (5+ min)] ‚Üí [Noise Peak] ‚Üí [Decay] ‚Üí [Silence/Minimal]'
                        }
                    ];
                    
                    const selectedInstrumentalStructure = instrumentalStructures[Math.floor(Math.random() * instrumentalStructures.length)];
                    
                    prompt = `‰Ω†ÊòØÂ∞àÊ•≠ÈÖçÊ®ÇÂ∏´/Èü≥Ê®ÇË£Ω‰Ωú‰∫∫ÔºåË´ãË®≠Ë®à‰∏ÄÈ¶ñÁ≤æÁ∑ªÁöÑÁ¥îÈü≥Ê®Ç‰ΩúÂìÅ„ÄÇ

„ÄêÈü≥Ê®ÇË®≠ÂÆö„Äë
- ‰∏ªÈ°å/Ê∞õÂúçÊÑèË±°Ôºö${theme}
- Êõ≤È¢®Ôºö${settings.genre.join(', ') || 'Ëá™Âãï'}
- ÊÉÖÊÑüÔºö${settings.mood.join(', ') || 'Ëá™Âãï'}
- ‰∏ªË¶ÅÊ®ÇÂô®Ôºö${settings.instruments.join(', ') || 'Ëá™Âãï'}
- ÁØÄÂ•è BPMÔºö${settings.bpm || 'Ëá™Âãï'}
- Âπ¥‰ª£ÊÑüÔºö${settings.era || 'Ëá™Âãï'}
- Ë™øÊÄßÔºö${settings.key || 'Ëá™Âãï'}
- Âú∞ÂüüÈ¢®Ê†ºÔºö${settings.region || 'Ëá™Âãï'}
- Ë£Ω‰ΩúË≥™ÊÑüÔºö${settings.production || 'Ëá™Âãï'}
- ÁâπÊÆäÊäÄÊ≥ïÔºö${settings.technique || 'ÁÑ°'}
- ÁõÆÊ®ôÊôÇÈï∑Ôºö${duration}
${settings.requirements ? `- È°çÂ§ñË¶ÅÊ±ÇÔºö${settings.requirements}` : ''}

„ÄêÊú¨Ê¨°ÁµêÊßã„Äë${selectedInstrumentalStructure.name}
ÊµÅÁ®ãÔºö${selectedInstrumentalStructure.tags}

„ÄêË£Ω‰ΩúË¶èÁØÑ„Äë
1. **ÁµêÊßãÊ®ôÁ±§**Ôºö‰ΩøÁî® Suno ÂèØËæ®Ë≠òÁöÑÊ®ôÁ±§Ôºà[Intro], [Build Up], [Drop], [Breakdown], [Bridge], [Outro] Á≠âÔºâ

2. **ÂãïÊÖãË®≠Ë®à**ÔºàÂøÖÈ†àÂåÖÂê´ÔºâÔºö
   - ÂãïÊÖãÂ±§Ê¨°Ëá≥Â∞ë 4 Â±§Ôºàpp ‚Üí p ‚Üí mf ‚Üí f ‚Üí ffÔºâ
   - Ê®ôË®ªÊØèÊÆµÁöÑËÉΩÈáèÁ≠âÁ¥ö (1-10)
   - ÊèèËø∞Êº∏ÈÄ≤/Êº∏Âº±ÁöÑÈÅéÊ∏°ÊñπÂºè

3. **Èü≥Ëâ≤ÊèèËø∞**ÔºöÊØèÊÆµÈúÄË™™Êòé
   - ‰∏ªÂ∞éÊ®ÇÂô®ÔºàLeadÔºâ
   - Â¢äÂ∫ïÈü≥Ëâ≤ÔºàPad/AmbientÔºâ
   - ÁØÄÂ•èÁµÑÔºàDrums/PercussionÔºâ
   - ÁâπÊÆäÈü≥ÊïàÔºàFX/TextureÔºâ

4. **Ë£Ω‰ΩúÁ¥∞ÁØÄ**ÔºöÊ®ôË®ª
   - ÂÅ¥ÈèàÂ£ìÁ∏ÆÔºàSidechainÔºâ‰ΩøÁî®
   - Á©∫ÈñìÊïàÊûúÔºàReverb/Delay È°ûÂûãÔºâ
   - ÊøæÊ≥¢Âô®ÂãïÊÖãÔºàFilter SweepÔºâ
   - Ëá™ÂãïÂåñÂèÉÊï∏ËÆäÂåñ

5. **ÊÉÖÊÑüÂºßÁ∑ö**Ôºö
   - ÈñãÂ†¥ÔºöÂª∫Á´ãÊ∞õÂúç
   - ÁôºÂ±ïÔºöÂ±§Â±§Â†ÜÁñä
   - È´òÊΩÆÔºöÊÉÖÊÑüÁàÜÁôº
   - Êî∂Â∞æÔºöÈ§òÈüªÂõûÂë≥

Ê†ºÂºèÁØÑ‰æãÔºö
[Intro] (ËÉΩÈáè 2/10)
- Lead: Á©∫ÈùàÈãºÁê¥ÂñÆÈü≥
- Pad: ÊöñËâ≤Âº¶Ê®Ç Pad (Èï∑ Reverb)
- Ê∞õÂúç: Èõ®ËÅ≤Êé°Ê®£
- ÂãïÊÖã: pp, Á∑©ÊÖ¢Ê∑°ÂÖ•

Ë´ãÁîüÊàê ${count} ÂÄãÈ¢®Ê†ºÂêÑÁï∞ÁöÑÁâàÊú¨ÔºåÁî® "=== ÁâàÊú¨ X ===" ÂàÜÈöî„ÄÇ
ÊØèÂÄãÁâàÊú¨Ë¶ÅÊúâ‰∏çÂêåÁöÑÁ∑®Êõ≤ÊÄùË∑ØÂíåÊÉÖÊÑüËµ∞Âêë„ÄÇ`;
                } else {
                    // Â§öÊ®£ÂåñÊ≠åÊõ≤ÁµêÊßãÊ®°Êùø
                    const structureTemplates = [
                        {
                            name: 'Á∂ìÂÖ∏ÊµÅË°å',
                            tags: '[Intro] ‚Üí [Verse 1] ‚Üí [Pre-Chorus] ‚Üí [Chorus] ‚Üí [Verse 2] ‚Üí [Pre-Chorus] ‚Üí [Chorus] ‚Üí [Bridge] ‚Üí [Final Chorus] ‚Üí [Outro]',
                            desc: 'ÊúÄÂ∏∏Ë¶ãÁöÑÊµÅË°åÊõ≤ÂºèÔºåPre-Chorus Ë£ΩÈÄ†ÂºµÂäõÔºåChorus ÈáãÊîæÊÉÖÊÑü'
                        },
                        {
                            name: 'Verse-Chorus Á∞°ÊΩîÂûã',
                            tags: '[Intro] ‚Üí [Verse 1] ‚Üí [Chorus] ‚Üí [Verse 2] ‚Üí [Chorus] ‚Üí [Verse 3] ‚Üí [Double Chorus] ‚Üí [Outro]',
                            desc: 'ÂéªÊéâ Pre-ChorusÔºåÁõ¥Êé•ÈÄ≤ÂâØÊ≠åÔºåÈÅ©ÂêàÊúóÊúó‰∏äÂè£ÁöÑÊ≠å'
                        },
                        {
                            name: 'AABA ÁàµÂ£´/Á∂ìÂÖ∏Âûã',
                            tags: '[A Section] ‚Üí [A Section (ËÆäÂ•è)] ‚Üí [B Section (Â∞çÊØîÊÆµ)] ‚Üí [A Section (ÂõûÊ≠∏)] ‚Üí [Coda]',
                            desc: 'Á∂ìÂÖ∏ 32 Â∞èÁØÄÊõ≤ÂºèÔºåB ÊÆµÂ∏∂‰æÜÂ∞çÊØîÂæåÂõûÂà∞ÁÜüÊÇâÁöÑ A'
                        },
                        {
                            name: 'Êïò‰∫ãÊº∏ÈÄ≤Âûã',
                            tags: '[Intro] ‚Üí [Verse 1] ‚Üí [Verse 2] ‚Üí [Lift] ‚Üí [Chorus] ‚Üí [Verse 3] ‚Üí [Chorus] ‚Üí [Breakdown] ‚Üí [Build] ‚Üí [Climax Chorus] ‚Üí [Outro]',
                            desc: 'Â±§Â±§Â†ÜÁñäÊÉÖÁ∑íÔºåÈÅ©ÂêàÊïÖ‰∫ãÊÄßÂº∑ÁöÑÊ≠å'
                        },
                        {
                            name: 'Áèæ‰ª£ EDM/K-Pop',
                            tags: '[Intro Hook] ‚Üí [Verse 1] ‚Üí [Pre-Chorus] ‚Üí [Drop/Chorus] ‚Üí [Post-Chorus] ‚Üí [Verse 2] ‚Üí [Pre-Chorus] ‚Üí [Drop/Chorus] ‚Üí [Bridge] ‚Üí [Final Drop] ‚Üí [Outro]',
                            desc: 'Âä†ÂÖ• Post-Chorus Âª∂Á∫åÈ´òÊΩÆÔºåDrop ÊÆµÂº∑Ë™øÁØÄÂ•è'
                        },
                        {
                            name: 'ÊäíÊÉÖÊïò‰∫ãÂûã',
                            tags: '[Soft Intro] ‚Üí [Verse 1] ‚Üí [Verse 2] ‚Üí [Pre-Chorus] ‚Üí [Chorus] ‚Üí [Interlude] ‚Üí [Verse 3] ‚Üí [Chorus] ‚Üí [Emotional Bridge] ‚Üí [A Cappella/Stripped Chorus] ‚Üí [Full Chorus] ‚Üí [Outro]',
                            desc: 'ÊÉÖÊÑüÂ±§Ê¨°Ë±êÂØåÔºåÈÅ©ÂêàÊäíÊÉÖÊÖ¢Ê≠å'
                        },
                        {
                            name: 'Hook È©ÖÂãïÂûã',
                            tags: '[Hook] ‚Üí [Verse 1] ‚Üí [Hook] ‚Üí [Verse 2] ‚Üí [Hook] ‚Üí [Bridge] ‚Üí [Hook x2] ‚Üí [Fade Out]',
                            desc: 'Hook Ë≤´Á©øÂÖ®Êõ≤ÔºåÊ¥óËÖ¶ÊóãÂæã'
                        },
                        {
                            name: 'Âè≤Ë©©/ÊêñÊªæÂûã',
                            tags: '[Epic Intro] ‚Üí [Verse 1] ‚Üí [Verse 2] ‚Üí [Pre-Chorus] ‚Üí [Chorus] ‚Üí [Instrumental Break] ‚Üí [Verse 3] ‚Üí [Pre-Chorus] ‚Üí [Double Chorus] ‚Üí [Guitar Solo/Bridge] ‚Üí [Quiet Section] ‚Üí [Build Up] ‚Üí [Final Chorus] ‚Üí [Epic Outro]',
                            desc: 'ÁµêÊßãÂÆåÊï¥ÔºåÈ´òÊΩÆËø≠Ëµ∑ÔºåÈÅ©ÂêàÊêñÊªæÊàñÂè≤Ë©©ÊÑüÊ≠åÊõ≤'
                        },
                        {
                            name: 'R&B/ÈùàÈ≠ÇÂûã',
                            tags: '[Intro Vamp] ‚Üí [Verse 1] ‚Üí [Chorus] ‚Üí [Verse 2] ‚Üí [Chorus] ‚Üí [Breakdown/Rap] ‚Üí [Ad-libs Section] ‚Üí [Chorus with Runs] ‚Üí [Outro Vamp]',
                            desc: 'Âä†ÂÖ•Âç≥Ëàà Ad-libs Âíå Vocal RunsÔºåÂ±ïÁèæÊ≠åÂî±ÊäÄÂ∑ß'
                        },
                        {
                            name: 'Ê∞ëË¨†/Áç®Á´ãÂûã',
                            tags: '[Finger-picking Intro] ‚Üí [Verse 1] ‚Üí [Verse 2] ‚Üí [Chorus] ‚Üí [Instrumental] ‚Üí [Verse 3] ‚Üí [Chorus] ‚Üí [Outro with Humming]',
                            desc: 'Á∞°Á¥ÑÁµêÊßãÔºåËëóÈáçÊ≠åË©ûÊïò‰∫ã'
                        }
                    ];
                    
                    // ÊäºÈüªÊ®°Âºè
                    const rhymeSchemes = [
                        { name: 'AABB (Â∞çÂè•Èüª)', desc: 'ÊØèÂÖ©Ë°åÊäºÈüªÔºåÁØÄÂ•èÊòéÂø´' },
                        { name: 'ABAB (‰∫§ÂèâÈüª)', desc: 'ÈöîË°åÊäºÈüªÔºåÂ±§Ê¨°ÂàÜÊòé' },
                        { name: 'ABBA (ÂåÖÂúçÈüª)', desc: 'È¶ñÂ∞æÂëºÊáâÔºåÁµêÊßãÂ∑•Êï¥' },
                        { name: 'AAAA (ÈÄ£Á∫åÈüª)', desc: 'ÂØÜÈõÜÊäºÈüªÔºåÂº∑Ë™øÁØÄÂ•èÊÑü' },
                        { name: 'ABCABC (‰∏âË°åÈüª)', desc: 'ÊØè‰∏âË°å‰∏ÄÁµÑÈüªËÖ≥' },
                        { name: 'Ëá™Áî±Èüª', desc: '‰∏çÊãòÊ≥•Âõ∫ÂÆöÈüªËÖ≥Ôºå‰ª•ÊÑèÂ¢ÉÁÇ∫‰∏ª' },
                        { name: 'ÂÖßÈüª', desc: 'ÈüªËÖ≥ËóèÂú®Âè•‰∏≠ËÄåÈùûÂè•Â∞æ' },
                        { name: 'Â∞æÂ≠óÁñäÈüª', desc: 'ÂâØÊ≠åÊØèÂè•ÁµêÂ∞æÁî®Áõ∏ÂêåÊàñÁõ∏‰ººÈü≥' }
                    ];
                    
                    // Êïò‰∫ãË¶ñËßí
                    const perspectives = [
                        'Á¨¨‰∏Ä‰∫∫Á®±Áç®ÁôΩÔºöÊàë/‰Ω† Â∞çË©±',
                        'Á¨¨‰∏â‰∫∫Á®±ÊóÅËßÄÔºö‰ªñ/Â•π ÁöÑÊïÖ‰∫ã',
                        'Á¨¨‰∫å‰∫∫Á®±ÂÇæË®¥ÔºöÁõ¥Êé•Â∞ç„Äå‰Ω†„ÄçË™™Ë©±',
                        'ÊÑèË≠òÊµÅÔºöÂÖßÂøÉÁ¢éÁâáÂºèÁç®ÁôΩ',
                        'Â†¥ÊôØÂàáÊèõÔºöÂ§öÈáçË¶ñËßí‰∫§ÈåØ',
                        'Êõ∏‰ø°/Êó•Ë®òÈ´îÔºöÂêëÊüê‰∫∫Ë®¥Ë™™'
                    ];
                    
                    // Èö®Ê©üÈÅ∏Êìá
                    const selectedStructure = structureTemplates[Math.floor(Math.random() * structureTemplates.length)];
                    const selectedRhyme = rhymeSchemes[Math.floor(Math.random() * rhymeSchemes.length)];
                    const selectedPerspective = perspectives[Math.floor(Math.random() * perspectives.length)];
                    
                    prompt = `‰Ω†ÊòØÈ†ÇÂ∞ñËèØË™ûË©ûÊõ≤Ââµ‰Ωú‰∫∫Ôºå‰ΩúÂìÅÊõæÁç≤ÈáëÊõ≤ÁçéËÇØÂÆö„ÄÇË´ã‰ª•Â∞àÊ•≠Ë©û‰∫∫ÁöÑÊ®ôÊ∫ñÂâµ‰ΩúÊ≠åË©û„ÄÇ

„ÄêÂâµ‰ΩúË®≠ÂÆö„Äë
- ‰∏ªÈ°å/ÊÑèË±°Ôºö${theme}
- Êõ≤È¢®Ôºö${settings.genre.join(', ') || 'Ëá™Âãï'}
- ÊÉÖÊÑüÂü∫Ë™øÔºö${settings.mood.join(', ') || 'Ëá™Âãï'}
- ÈÖçÂô®È¢®Ê†ºÔºö${settings.instruments.join(', ') || 'Ëá™Âãï'}
- ÁØÄÂ•è BPMÔºö${settings.bpm || 'Ëá™Âãï'}
- Âπ¥‰ª£ÊÑüÔºö${settings.era || 'Ëá™Âãï'}
- Ë™øÊÄßÔºö${settings.key || 'Ëá™Âãï'}
- Âú∞ÂüüËâ≤ÂΩ©Ôºö${settings.region || 'Ëá™Âãï'}
- Ë£Ω‰ΩúË≥™ÊÑüÔºö${settings.production || 'Ëá™Âãï'}
- ÊºîÂî±ÂûãÊÖãÔºö${settings.voice}
- Ë™ûË®ÄÔºö${settings.language.join('„ÄÅ') || 'ÁπÅÈ´î‰∏≠Êñá'}
- ‰∫∫ËÅ≤ÊïàÊûúÔºö${settings.vocalEffect || 'Ëá™ÁÑ∂'}
- Ê≠åË©ûÈ¢®Ê†ºÔºö${settings.lyricStyle || 'Ëá™Âãï'}
- Ê≠åÊõ≤Ê∞õÂúçÔºö${settings.songVibe || 'Ëá™Âãï'}
- ÁõÆÊ®ôÊôÇÈï∑Ôºö${duration}
${settings.requirements ? `- ÁâπÊÆäË¶ÅÊ±ÇÔºö${settings.requirements}` : ''}

„ÄêÊú¨Ê¨°Ââµ‰ΩúÁµêÊßã„Äë${selectedStructure.name}
ÁµêÊßãÊµÅÁ®ãÔºö${selectedStructure.tags}
ÁâπÈªûË™™ÊòéÔºö${selectedStructure.desc}

„ÄêÊäºÈüªÊ®°Âºè„Äë${selectedRhyme.name}
Ë™™ÊòéÔºö${selectedRhyme.desc}

„ÄêÊïò‰∫ãË¶ñËßí„Äë${selectedPerspective}

„ÄêÂ∞àÊ•≠ÂØ´Ë©ûË¶èÁØÑ„Äë
1. „ÄêÁµêÊßãÂ∏ÉÂ±Ä„Äë
   - Âö¥Ê†ºÊåâÁÖß‰∏äËø∞ÁµêÊßãÊ®ôÁ±§Ââµ‰ΩúÔºåÊØèÂÄãÊÆµËêΩÁî® [Ê®ôÁ±§] Ê®ôÁ§∫
   - Verse ÊÆµÔºöÈã™Èô≥ÊïÖ‰∫ã/ÊÉÖÂ¢ÉÔºåÊØèÊÆµ 4-6 Ë°å
   - Pre-ChorusÔºöÊÉÖÁ∑íÂ†ÜÁñäÈÅéÊ∏°Ôºå2-4 Ë°åÔºåË£ΩÈÄ†„ÄåÂç≥Â∞áÁàÜÁôº„ÄçÁöÑÂºµÂäõ
   - ChorusÔºöÊÉÖÊÑüÊ†∏ÂøÉÔºåÂåÖÂê´‰∏ÄÂÄãË®òÊÜ∂Èªû HookÔºàÊúÄÂ•ΩÊòØÊ≠åÂêçÊàñÊ†∏ÂøÉÊ¶ÇÂøµÔºâ
   - BridgeÔºöËΩâÊäò/ÊòáËèØÔºåÂ∏∂ÂÖ•Êñ∞Ë¶ñËßíÊàñÈ†ìÊÇü
   - ÂêÑÊÆµËêΩÈñìË¶ÅÊúâÊÉÖÁ∑íÁöÑ„ÄåËµ∑ÊâøËΩâÂêà„Äç

2. „ÄêÊóãÂæãÊÄßËàáÁØÄÂ•è„Äë
   - ÊØèË°åÊéßÂà∂Âú® 5-15 Â≠óÔºåÈÅ©ÂêàÊºîÂî±
   - Ê≥®ÊÑè„ÄåÂ≠óÊï∏Â∞çÁ®±„ÄçÔºöÂêå‰∏ÄÊÆµËêΩÂêÑË°åÂ≠óÊï∏Áõ∏ËøëÔºå‰æøÊñºÊóãÂæãÈáçË§á
   - Âä†ÂÖ•ÂèØÂª∂Èï∑ÁöÑÈñãÂè£Èü≥ÔºàÂïä„ÄÅÂì¶„ÄÅÂñîÔºâÂú®ÊÉÖÊÑüÈ´òÈªû
   - Chorus Ë¶Å„ÄåÂ•ΩÂî±Â•ΩË®ò„ÄçÔºåÈÅøÂÖçÁπûÂè£ÁöÑË©û

3. „ÄêÊäºÈüªÊäÄÂ∑ß„Äë
   - ‰ΩøÁî®‰∏äËø∞ÊäºÈüªÊ®°ÂºèÔºåÂèØÈÅ©Â∫¶ËÆäÂåñ
   - ÂèØÁî®„ÄåËøëÈüª„Äç„ÄåË´ßÈü≥Èüª„ÄçÂ¢ûÂä†ÈùàÊ¥ªÊÄß
   - ÂâØÊ≠åÊäºÈüªË¶ÅÊõ¥Â∑•Êï¥ÔºåVerse ÂèØÁ®çËá™Áî±
   - ÈÅøÂÖçÁÇ∫ÊäºÈüªËÄåÁäßÁâ≤Ë™ûÊÑèÊµÅÊö¢

4. „ÄêÊÑèË±°Ëàá‰øÆËæ≠„Äë
   - Áî®ÂÖ∑È´îÊÑèË±°Âèñ‰ª£ÊäΩË±°ÂΩ¢ÂÆπÔºà„ÄåÁúºÁú∂Ê≥õÁ¥Ö„ÄçÊØî„ÄåÂæàÈõ£ÈÅé„ÄçÂ•ΩÔºâ
   - ÂñÑÁî®‰∫îÊÑüÊèèÂØ´ÔºöË¶ñË¶∫„ÄÅËÅΩË¶∫„ÄÅËß∏Ë¶∫„ÄÅÂóÖË¶∫„ÄÅÂë≥Ë¶∫
   - ÈÅãÁî®ÊØîÂñª„ÄÅÊì¨‰∫∫„ÄÅÈÄöÊÑüÁ≠â‰øÆËæ≠
   - Âª∫Á´ãË≤´Á©øÂÖ®Êõ≤ÁöÑÊ†∏ÂøÉÊÑèË±°/Ë±°Âæµ
   - ÈÅøÂÖçÈô≥ËÖîÊø´Ë™øÔºåÂ∞ãÊâæÊñ∞ÈÆÆÁöÑË°®ÈÅî

5. „ÄêÊÉÖÊÑüÂ±§Ê¨°„Äë
   - Verse 1ÔºöÂª∫Á´ãÂ†¥ÊôØ/ÂºïÂÖ•
   - Verse 2ÔºöÁôºÂ±ï/Ê∑±Âåñ
   - Verse 3ÔºàÂ¶ÇÊúâÔºâÔºöËΩâÊäò/È´òÊΩÆÂâçÂ•è
   - ÊØèÂÄã Chorus ÂèØ‰ª•ÊúâÂæÆÂ¶ôÁöÑË©ûÂè•ËÆäÂåñÔºåÂèçÊò†ÊÉÖÊÑüÈÅûÈÄ≤
   - Bridge Ë¶ÅÊúâ„ÄåÈ†ìÊÇüÊôÇÂàª„ÄçÊàñÊÉÖÊÑüËΩâÊäò

6. „ÄêË™ûË®ÄÈÅãÁî®„Äë
   - Âè£Ë™ûÂåñ‰ΩÜ‰∏çÁ≤ó‰øóÔºåÊñáÂ≠∏ÊÄß‰ΩÜ‰∏çËâ±ÊæÄ
   - ÂèØÈÅ©Â∫¶Ê∑∑Êê≠Ë™ûË®ÄÔºàÂ¶Ç Chorus Áî®Ëã±Êñá HookÔºâ
   - ÊñπË®Ä„ÄÅ‰øöË™ûÂèØÂ¢ûÊ∑ªÂú∞ÂüüÁâπËâ≤ÔºàË¶ñË®≠ÂÆöÔºâ
   - ÈÅøÂÖçÈÅéÂ∫¶Êõ∏Èù¢ÂåñÁöÑË©ûÂΩô

Ë´ãÁîüÊàê ${count} ÂÄãÈ¢®Ê†ºÂêÑÁï∞ÁöÑÁâàÊú¨„ÄÇ
- ÊØèÂÄãÁâàÊú¨‰ΩøÁî®„Äê‰∏çÂêåÁöÑÂàáÂÖ•ËßíÂ∫¶„ÄëÂíå„Äê‰∏çÂêåÁöÑÊÉÖÊÑüË©ÆÈáã„Äë
- ÂèØËÆäÂåñÈüªËÖ≥„ÄÅÊÑèË±°Á≥ªÁµ±„ÄÅÊïò‰∫ãË¶ñËßí
- Áî® "=== ÁâàÊú¨ X ===" ÂàÜÈöîÂêÑÁâàÊú¨`;
                }
            }
            lastPromptText = prompt;

            try {
                const response = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: creativity,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 16384,
                        }
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Ë´ãÊ±ÇÂ§±Êïó (${response.status}): ${errText || 'Êú™Áü•ÈåØË™§'}`);
                }

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const fullText = data.candidates[0].content.parts[0].text;
                
                if (isAlbumMode) {
                    // Ëß£ÊûêÂ∞àËºØÊ†ºÂºè
                    const albumNameMatch = fullText.match(/„ÄêÂ∞àËºØÂêçÁ®±„Äë[Ôºö:]*\s*(.+)/);
                    const albumName = albumNameMatch ? albumNameMatch[1].trim() : theme;
                    
                    const trackParts = fullText.split(/===\s*Á¨¨\s*\d+\s*È¶ñ\s*===/);
                    const tracks = [];
                    
                    for (let i = 1; i < trackParts.length; i++) {
                        const part = trackParts[i].trim();
                        const titleMatch = part.match(/„ÄêÊ≠åÂêç„Äë[Ôºö:]*\s*(.+)/);
                        const title = titleMatch ? titleMatch[1].trim() : `Track ${i}`;
                        
                        let lyrics = part.replace(/„ÄêÊ≠åÂêç„Äë[Ôºö:]*\s*.+\n?/, '').replace(/„ÄêÊ≠åË©û[\/ÁµêÊßã]*„Äë\n?/g, '').trim();
                        
                        tracks.push({
                            title,
                            lyrics,
                            stylePrompt: stylePrompts[i - 1] || stylePrompts[0]
                        });
                    }
                    // ÈôêÂà∂ÁÇ∫‰ΩøÁî®ËÄÖÈÅ∏ÂÆöÁöÑÊõ≤ÁõÆÊï∏
                    if (tracks.length > count) {
                        tracks = tracks.slice(0, count);
                    }
                    
                    generatedAlbum = { name: albumName, tracks };
                    generatedVersions = [];
                    renderAlbum(generatedAlbum);
                } else {
                    // Ëß£ÊûêÂñÆÊõ≤ÁâàÊú¨Ê†ºÂºè
                    let versions = [];
                    if (count > 1) {
                        const parts = fullText.split(/===\s*ÁâàÊú¨\s*\d+\s*===/);
                        versions = parts.filter(p => p.trim()).map((text, idx) => ({
                            lyrics: text.trim(),
                            stylePrompt: stylePrompts[idx] || stylePrompts[0]
                        }));
                    versions = versions.slice(0, count);
                    } else {
                        versions = [{ lyrics: fullText.trim(), stylePrompt: stylePrompts[0] }];
                    }
                // ‰øùË≠âÂñÆÁâàÊú¨ÊôÇÂè™‰øùÁïôÁ¨¨‰∏ÄÁ≠Ü
                if (count === 1 && versions.length > 1) {
                    versions = [versions[0]];
                    }
                    
                    generatedVersions = versions;
                    generatedAlbum = null;
                    renderVersions(versions);
                }
                
                // ‰øùÂ≠òÁîüÊàêÁµêÊûú
                await saveGeneratedResult();
                await saveHistoryEntry();
                updateSafetyPanel();
                
                document.getElementById('resultSection').classList.add('show');
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                if (error.name === 'AbortError') {
                    alert('ÁîüÊàêÈÄæÊôÇÔºåË´ãÁ®çÂæåÂÜçË©¶ÊàñÈôç‰ΩéÁîüÊàêÊï∏Èáè„ÄÇ');
                } else {
                alert('ÁîüÊàêÂ§±Êïó:' + error.message);
                }
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('loading').classList.remove('show');
            }
        }

        // ===== Ê∏≤ÊüìÂñÆÊõ≤ÁµêÊûú =====
        function renderVersions(versions) {
            document.getElementById('albumInfo').style.display = 'none';
            document.getElementById('versionTabs').innerHTML = '';
            document.getElementById('versionsContainer').innerHTML = '';
            
            // ‰ΩøÁî®ÂíåÂ∞àËºØ‰∏ÄÊ®£ÁöÑÂ±ïÈñãÂºèÂàóË°®
            document.getElementById('trackList').innerHTML = versions.map((v, i) => `
                <div class="track-item ${i === 0 ? 'active' : ''}" id="version-${i}">
                    <div class="track-header" onclick="toggleVersion(${i})">
                        <div class="track-number">${i + 1}</div>
                        <div class="track-info">
                            <div class="track-title">ÁâàÊú¨ ${i + 1}</div>
                            <div class="track-style">${v.stylePrompt}</div>
                        </div>
                        <div class="track-toggle">‚ñº</div>
                    </div>
                    <div class="track-content">
                        <div class="style-prompt-section">
                            <div class="style-prompt-header">üé® Suno È¢®Ê†ºÊèêÁ§∫Ë©û</div>
                            <div class="style-prompt-output">${v.stylePrompt}</div>
                            <button class="copy-style-prompt-btn" onclick="copyText('${encodeURIComponent(v.stylePrompt)}', this)">üìã Ë§áË£ΩÊèêÁ§∫Ë©û</button>
                        </div>
                        <pre class="lyrics-output">${escapeHtml(v.lyrics)}</pre>
                        <div class="action-buttons">
                            <button class="action-btn copy-btn" onclick="copyLyrics(${i})">üìã Ë§áË£Ω</button>
                            <button class="action-btn suno-btn" onclick="window.open('https://suno.com/create','_blank')">üöÄ Suno</button>
                            <button class="action-btn export-btn" onclick="exportVersion(${i})">üíæ ÂåØÂá∫</button>
                            <button class="action-btn add-lib-btn" onclick="addToLibrary(${i})">üìö Êî∂Ëóè</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleVersion(idx) {
            const version = document.getElementById(`version-${idx}`);
            version.classList.toggle('active');
        }

        // ===== Ê∏≤ÊüìÂ∞àËºØÁµêÊûú =====
        function renderAlbum(album) {
            document.getElementById('versionTabs').innerHTML = '';
            document.getElementById('versionsContainer').innerHTML = '';
            
            document.getElementById('albumInfo').style.display = 'block';
            document.getElementById('albumName').textContent = album.name;
            document.getElementById('albumMeta').textContent = `ÂÖ± ${album.tracks.length} È¶ñÊ≠åÊõ≤`;
            
            document.getElementById('trackList').innerHTML = album.tracks.map((track, i) => `
                <div class="track-item" id="track-${i}">
                    <div class="track-header" onclick="toggleTrack(${i})">
                        <div class="track-number">${i + 1}</div>
                        <div class="track-info">
                            <div class="track-title">${escapeHtml(track.title)}</div>
                            <div class="track-style">${track.stylePrompt}</div>
                        </div>
                        <div class="track-toggle">‚ñº</div>
                    </div>
                    <div class="track-content">
                        <div class="style-prompt-section">
                            <div class="style-prompt-header">üé® Suno È¢®Ê†ºÊèêÁ§∫Ë©û</div>
                            <div class="style-prompt-output">${track.stylePrompt}</div>
                            <button class="copy-style-prompt-btn" onclick="copyText('${encodeURIComponent(track.stylePrompt)}', this)">üìã Ë§áË£ΩÊèêÁ§∫Ë©û</button>
                        </div>
                        <pre class="lyrics-output">${escapeHtml(track.lyrics)}</pre>
                        <div class="action-buttons">
                            <button class="action-btn copy-btn" onclick="copyTrackLyrics(${i})">üìã Ë§áË£Ω</button>
                            <button class="action-btn suno-btn" onclick="window.open('https://suno.com/create','_blank')">üöÄ Suno</button>
                            <button class="action-btn export-btn" onclick="exportTrack(${i})">üíæ ÂåØÂá∫</button>
                            <button class="action-btn add-lib-btn" onclick="addTrackToLibrary(${i})">üìö Êî∂Ëóè</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleTrack(idx) {
            const track = document.getElementById(`track-${idx}`);
            track.classList.toggle('active');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function switchVersion(idx) {
            document.querySelectorAll('.version-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
            document.querySelectorAll('.version-content').forEach((c, i) => c.classList.toggle('active', i === idx));
        }

        // ===== Ë§áË£Ω/ÂåØÂá∫ÂäüËÉΩ =====
        function copyText(encoded, btn) {
            navigator.clipboard.writeText(decodeURIComponent(encoded)).then(() => {
                const orig = btn.textContent;
                btn.textContent = '‚úÖ Â∑≤Ë§áË£Ω!';
                setTimeout(() => btn.textContent = orig, 2000);
            });
        }

        function copyLyrics(idx) {
            const lyrics = generatedVersions[idx]?.lyrics || '';
            const btn = event.target;
            
            navigator.clipboard.writeText(lyrics).then(() => {
                const orig = btn.textContent;
                btn.textContent = '‚úÖ Â∑≤Ë§áË£Ω!';
                setTimeout(() => btn.textContent = orig, 2000);
            });
        }

        function copyTrackLyrics(idx) {
            const lyrics = generatedAlbum?.tracks[idx]?.lyrics || '';
            const btn = event.target;
            
            navigator.clipboard.writeText(lyrics).then(() => {
                const orig = btn.textContent;
                btn.textContent = '‚úÖ Â∑≤Ë§áË£Ω!';
                setTimeout(() => btn.textContent = orig, 2000);
            });
        }

        function exportVersion(idx) {
            const v = generatedVersions[idx];
            if (!v) return;
            const data = {
                theme: document.getElementById('theme').value,
                lyrics: v.lyrics.split('\n'),
                stylePrompt: v.stylePrompt,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `lyrics_v${idx + 1}_${Date.now()}.json`;
            link.click();
        }

        function exportTrack(idx) {
            const track = generatedAlbum?.tracks[idx];
            if (!track) return;
            const data = {
                albumName: generatedAlbum.name,
                trackNumber: idx + 1,
                title: track.title,
                lyrics: track.lyrics.split('\n'),
                stylePrompt: track.stylePrompt,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${track.title}_${Date.now()}.json`;
            link.click();
        }

        function copyPrompt() {
            if (!lastPromptText) return alert('Â∞öÊú™ÁîüÊàêÊèêÁ§∫Ë©û');
            navigator.clipboard.writeText(lastPromptText).then(() => alert('‚úÖ ÊèêÁ§∫Ë©ûÂ∑≤Ë§áË£Ω'));
        }

        function getAllLyricsText() {
            if (generatedAlbum && generatedAlbum.tracks?.length) {
                return generatedAlbum.tracks.map((t, i) => `=== Á¨¨ ${i + 1} È¶ñÔºö${t.title} ===\n${t.lyrics}`).join('\n\n');
            }
            return (generatedVersions || []).map((v, i) => `=== ÁâàÊú¨ ${i + 1} ===\n${v.lyrics}`).join('\n\n');
        }

        function exportMarkdown() {
            if ((!generatedVersions || generatedVersions.length === 0) && !generatedAlbum) {
                return alert('Ê≤íÊúâÂèØÂåØÂá∫ÁöÑÂÖßÂÆπ');
            }
            const theme = document.getElementById('theme').value || 'Êú™ÂëΩÂêç';
            let md = `# ${theme}\n\n## Ë®≠ÂÆöÊëòË¶Å\n- Ê®°Âºè: ${generatedAlbum ? 'Â∞àËºØ' : 'ÂñÆÊõ≤'}\n- È°ûÂûã: ${document.querySelector('input[name="songType"]:checked').value === 'instrumental' ? 'Á¥îÈü≥Ê®Ç' : '‰∫∫ËÅ≤'}\n`;
            if (lastPromptText) md += `- ÊèêÁ§∫Ë©ûÈï∑Â∫¶: ${lastPromptText.length} Â≠ó\n`;
            md += `\n## È¢®Ê†ºÊèêÁ§∫Ë©û\n`;
            if (generatedAlbum?.tracks?.length) {
                generatedAlbum.tracks.forEach((t, i) => {
                    md += `### Track ${i + 1} - ${t.title}\nSuno Ê®£Âºè: ${t.stylePrompt}\n\n`;
                });
            } else {
                (generatedVersions || []).forEach((v, i) => {
                    md += `### ÁâàÊú¨ ${i + 1}\nSuno Ê®£Âºè: ${v.stylePrompt}\n\n`;
                });
            }
            md += `\n## Ê≠åË©û\n${getAllLyricsText()}\n`;
            const blob = new Blob([md], { type: 'text/markdown' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${theme}_lyrics_${Date.now()}.md`;
            link.click();
        }

        function importLyrics(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.theme) document.getElementById('theme').value = data.theme;
                    let lyrics = data.lyrics;
                    if (Array.isArray(lyrics)) lyrics = lyrics.join('\n');
                    generatedVersions = [{ lyrics, stylePrompt: data.stylePrompt || '' }];
                    generatedAlbum = null;
                    renderVersions(generatedVersions);
                    await saveGeneratedResult();
                    document.getElementById('resultSection').classList.add('show');
                    alert('‚úÖ ÂåØÂÖ•ÊàêÂäü!');
                } catch { alert('ÂåØÂÖ•Â§±Êïó'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ===== ÂÆâÂÖ®Ê™¢Êü•Ëàá‰øÆÊ≠£ÊèêÁ§∫ =====
        function updateSafetyPanel() {
            const panel = document.getElementById('safetyPanel');
            const list = document.getElementById('safetyList');
            const lyricsText = getAllLyricsText();
            if (!lyricsText) {
                panel.style.display = 'none';
                return;
            }
            const warnings = [];
            if (!/\[[^\]]+\]/.test(lyricsText)) {
                warnings.push('Áº∫Â∞ë Suno Ê®ôÁ±§ (Â¶Ç [Intro]/[Chorus])');
            }
            if (lyricsText.length > 4000) {
                warnings.push('Ê≠åË©ûÈÅéÈï∑ÔºåÂèØËÉΩË∂ÖÂá∫ Suno Ëº∏ÂÖ•ÈôêÂà∂');
            }
            if (!warnings.length) {
                panel.style.display = 'none';
                return;
            }
            list.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
            panel.style.display = 'block';
        }

        function buildSafetyPrompt() {
            return `Ë´ãÂú®‰øùÁïôÂéüÊÑèÁöÑÂâçÊèê‰∏ã‰øÆÊ≠£‰ª•‰∏ãÊ≠åË©ûÔºåÁ¢∫‰øùÂåÖÂê´ Suno Ê®ôÁ±§‰∏¶ÊéßÂà∂Èï∑Â∫¶ÈÅ©‰∏≠Ôºö\n${getAllLyricsText()}`;
        }

        function copySafetyPrompt() {
            const fixPrompt = buildSafetyPrompt();
            navigator.clipboard.writeText(fixPrompt).then(() => alert('‚úÖ ‰øÆÊ≠£ÊèêÁ§∫Ë©ûÂ∑≤Ë§áË£Ω'));
        }

        // ===== Ê≠∑Âè≤ÁâàÊú¨ / Â∞çÊØî =====
        async function saveHistoryEntry() {
            const entry = {
                id: Date.now(),
                theme: document.getElementById('theme').value || 'Êú™ÂëΩÂêç',
                isAlbum: !!generatedAlbum,
                versions: generatedVersions,
                album: generatedAlbum,
                prompt: lastPromptText,
                createdAt: new Date().toLocaleString()
            };
            generatedHistory.unshift(entry);
            generatedHistory = generatedHistory.slice(0, HISTORY_LIMIT);
            try {
                await saveToIndexedDB(RESULT_STORE, 'history', generatedHistory);
                renderHistory();
            } catch (e) {
                console.warn('save history failed', e);
            }
        }

        async function loadHistory() {
            try {
                const data = await loadFromIndexedDB(RESULT_STORE, 'history');
                generatedHistory = data || [];
                renderHistory();
            } catch (e) {
                generatedHistory = [];
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            document.getElementById('historyCount').textContent = generatedHistory.length;
            if (!generatedHistory.length) {
                list.innerHTML = '<p style="color:var(--text-muted);">ÁõÆÂâçÊ≤íÊúâÊ≠∑Âè≤Ë®òÈåÑ</p>';
                document.getElementById('diffViewer').style.display = 'none';
                return;
            }
            list.innerHTML = generatedHistory.map(h => `
                <div class="history-item">
                    <div class="history-meta">
                        <span>üéµ ${escapeHtml(h.theme)}</span>
                        <span>${h.isAlbum ? 'Â∞àËºØ' : 'ÂñÆÊõ≤'}</span>
                        <span>${h.createdAt}</span>
                    </div>
                    <div class="history-actions">
                        <button class="btn-load" onclick="loadHistoryItem(${h.id})">ËºâÂÖ•</button>
                        <button class="btn-secondary" onclick="compareHistory(${h.id})">Â∞çÊØî</button>
                    </div>
                </div>
            `).join('');
        }

        function loadHistoryItem(id) {
            const item = generatedHistory.find(h => h.id === id);
            if (!item) return;
            generatedVersions = item.versions || [];
            generatedAlbum = item.album || null;
            lastPromptText = item.prompt || '';
            if (generatedAlbum?.tracks?.length) {
                renderAlbum(generatedAlbum);
            } else {
                renderVersions(generatedVersions);
            }
            saveGeneratedResult();
            updateSafetyPanel();
            document.getElementById('resultSection').classList.add('show');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function simpleDiff(a, b) {
            const aLines = a.split('\n');
            const bLines = b.split('\n');
            const max = Math.max(aLines.length, bLines.length);
            const out = [];
            for (let i = 0; i < max; i++) {
                const left = aLines[i] || '';
                const right = bLines[i] || '';
                if (left === right) {
                    out.push(left);
                } else {
                    if (left) out.push(`<span class="diff-del">- ${escapeHtml(left)}</span>`);
                    if (right) out.push(`<span class="diff-add">+ ${escapeHtml(right)}</span>`);
                }
            }
            return out.join('\n');
        }

        function compareHistory(id) {
            const item = generatedHistory.find(h => h.id === id);
            if (!item) return;
            const current = getAllLyricsText();
            const oldText = (item.album ? item.album.tracks.map((t, i) => `=== Á¨¨ ${i + 1} È¶ñÔºö${t.title} ===\n${t.lyrics}`).join('\n\n') : (item.versions || []).map((v, i) => `=== ÁâàÊú¨ ${i + 1} ===\n${v.lyrics}`).join('\n\n')) || '';
            const diffHtml = simpleDiff(oldText, current);
            const viewer = document.getElementById('diffViewer');
            viewer.innerHTML = diffHtml || 'ÁÑ°Â∑ÆÁï∞ÊàñÂÖßÂÆπÁ©∫ÁôΩ';
            viewer.style.display = 'block';
            viewer.scrollIntoView({ behavior: 'smooth' });
        }

        // ===== AI ÁîüÊàê‰∏ªÈ°å =====
        async function generateRandomTheme() {
            const apiKey = await getApiKey();
            if (!apiKey) { 
                alert('Ë´ãÂÖàË®≠ÂÆö API ÈáëÈë∞'); 
                openApiModal(); 
                return; 
            }

            const btn = document.getElementById('generateThemeBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ ÁîüÊàê‰∏≠...';
            btn.disabled = true;

            // Â§öÁ∂≠Â∫¶ÁµÑÂêàÁ≥ªÁµ± - Áî¢Áîü‰∏äËê¨Á®ÆÊéíÂàóÁµÑÂêà
            const scenes = ['Ê∑±Â§úÁöÑ', 'ÂçàÂæåÁöÑ', 'Ê∏ÖÊô®ÁöÑ', 'Èõ®Â§úÁöÑ', 'Èõ™Â§©ÁöÑ', 'ÈªÉÊòèÁöÑ', 'Ê≠£ÂçàÁöÑ', 'ÂáåÊô®ÁöÑ', 'Èúß‰∏≠ÁöÑ', 'ÊòüÁ©∫‰∏ãÁöÑ', 'Êµ∑ÈÇäÁöÑ', 'Â±±È†ÇÁöÑ', 'ÂüéÂ∏ÇÁöÑ', 'ÈÑâÊùëÁöÑ', 'Âú∞ÈêµÁöÑ', 'ÂíñÂï°Â∫óÁöÑ', '‰æøÂà©Â∫óÁöÑ', 'ÂúñÊõ∏È§®ÁöÑ', 'ÈõªÂΩ±Èô¢ÁöÑ', 'ÂÖ¨ÂúíÁöÑ', 'Â±ãÈ†ÇÁöÑ', 'ÈôΩÂè∞ÁöÑ', 'ËªäÁ´ôÁöÑ', 'Ê©üÂ†¥ÁöÑ', 'Á¢ºÈ†≠ÁöÑ', 'Ê©ã‰∏ãÁöÑ', 'ÈößÈÅìË£°ÁöÑ', 'Â∞èÂ∑∑ÁöÑ', 'Âª£Â†¥ÁöÑ', 'ÊïôÂ†ÇÁöÑ'];
            const times = ['Êò®Â§©', '‰ªäÂ§©', 'ÊòéÂ§©', 'Ê≠§Âàª', 'ÈÇ£Âπ¥', 'ÈÇ£Â§ú', 'ÈÇ£Âπ¥Â§èÂ§©', 'ÈÇ£ÂÄãÂÜ¨Â§©', 'ÂçÅ‰∏ÉÊ≠≤', '‰∫åÂçÅ‰∫îÊ≠≤', '‰∏âÂçÅÊ≠≤', 'Êú™‰æÜ', 'ÈÅéÂéª', 'Ê∞∏ÊÅÜ', 'Áû¨Èñì', 'ÈÄ±Êú´', 'ÈÄ±‰∏Ä', 'Ê∑±Â§ú', 'Ê∏ÖÊô®', 'ÂçàÂæå', 'ÈªÉÊòè', 'ÂçàÂ§ú', 'ÈªéÊòé', 'ÂÇçÊôö', 'Êò•Â§©', 'Â§èÂ§©', 'ÁßãÂ§©', 'ÂÜ¨Â§©', 'ÊüêÂÄã', 'ÊüêÊ¨°'];
            const emotions = ['ÈåØÈÅéÁöÑ', 'Á≠âÂæÖÁöÑ', 'ÂëäÂà•ÁöÑ', 'ÈáçÈÄ¢ÁöÑ', 'ÈÅ∫ÂøòÁöÑ', 'Ë®òËµ∑ÁöÑ', 'Â∞ãÊâæÁöÑ', 'Â§±ÂéªÁöÑ', 'ÂæóÂà∞ÁöÑ', 'ÊîæÊ£ÑÁöÑ', 'Â†ÖÊåÅÁöÑ', 'ÈÄÉÈõ¢ÁöÑ', 'ËøΩÂ∞ãÁöÑ', 'ÊìÅÊä±ÁöÑ', 'ÊîæÊâãÁöÑ', 'Áõ∏ÈÅáÁöÑ', 'ÂàÜÈõ¢ÁöÑ', 'Áõ∏ÊÑõÁöÑ', 'ÈåØÈÅéÁöÑ', 'Ë™§Ëß£ÁöÑ', 'ÂéüË´íÁöÑ', 'ÊÑüË¨ùÁöÑ', 'Êá∑ÂøµÁöÑ', 'ÊúüÂæÖ', 'ÂÆ≥ÊÄï', 'ÂãáÊï¢', 'Â≠§Áç®', 'Ê∫´Êöñ', 'ÂÜ∞ÂÜ∑', 'Ëá™Áî±'];
            const objects = ['‰ø°', 'ÁÖßÁâá', 'Êó•Ë®ò', 'Èë∞Âåô', 'ÈêòËÅ≤', 'Èà¥ËÅ≤', 'ÁÖôÁÅ´', 'ÂΩ©Ëôπ', 'ÊµÅÊòü', 'ÊúàÂÖâ', 'ÈôΩÂÖâ', 'È¢®', 'Èõ®', 'Èõ™', 'Èúß', 'ÂΩ±Â≠ê', 'ËÅ≤Èü≥', 'Âë≥ÈÅì', 'Ëß∏ÊÑü', 'Ê∫´Â∫¶', 'È°èËâ≤', 'ÂÖâ', 'Êöó', 'Ë∑Ø', 'ÈñÄ', 'Á™ó', 'ÁâÜ', 'Ê¢Ø', 'Ê©ã', 'Ëàπ'];
            const actions = ['ÂØ´Áµ¶', 'ÂØÑÁµ¶', 'ÈÄÅÁµ¶', 'ÁïôÁµ¶', 'ÈÇÑÁµ¶', 'ÂÅ∑Ëµ∞', 'Â∏∂Ëµ∞', 'Áïô‰∏ã', 'ÂøòË®ò', 'Ë®òËµ∑', 'Â∞ãÊâæ', 'ÊâæÂà∞', 'Â§±Âéª', 'ÂæóÂà∞', 'ÊâìÈñã', 'Èóú‰∏ä', 'Èªû‰∫Æ', 'ÁÜÑÊªÖ', 'ËÅΩË¶ã', 'ÁúãË¶ã', 'Ëß∏Êë∏', 'ÊÑüÂèó', 'ÊÉ≥ÂÉè', 'Â§¢Ë¶ã', 'ÈÜí‰æÜ', 'ÂÖ•Áù°', 'Èõ¢Èñã', 'Âõû‰æÜ', 'Á≠âÂæÖ', 'ÈÅáË¶ã'];
            const styles = ['Êµ™Êº´', 'ÊÜÇÂÇ∑', 'Ê≠°Âø´', 'Ê∑±Ê≤â', 'ËºïÂø´', 'ÊøÄÊòÇ', 'Âπ≥Èùú', 'ÊøÄÁõ™', 'Ê∫´Êüî', 'Âº∑ÁÉà', 'Á¥∞ËÜ©', 'Á≤óÁç∑', 'Â§¢Âπª', 'ÁèæÂØ¶', 'ÊäΩË±°', 'ÂÖ∑È´î', 'Êòé‰∫Æ', 'Èô∞Êöó', 'Ê∫´Êöñ', 'ÂÜ∑ÂÜΩ'];
            
            // Èö®Ê©üÁµÑÂêà 2-4 ÂÄãÁ∂≠Â∫¶ÔºåÁ¢∫‰øùÊØèÊ¨°‰∏çÂêå
            const comboParts = [];
            const numParts = 2 + Math.floor(Math.random() * 3); // 2-4ÂÄãÈÉ®ÂàÜ
            
            // Èö®Ê©üÈÅ∏Êìá‰∏çÂêåÁ∂≠Â∫¶ÁöÑÂÖÉÁ¥†ÔºåÈÅøÂÖçÈáçË§á
            const dimensions = [
                () => scenes[Math.floor(Math.random() * scenes.length)],
                () => times[Math.floor(Math.random() * times.length)],
                () => emotions[Math.floor(Math.random() * emotions.length)],
                () => objects[Math.floor(Math.random() * objects.length)],
                () => actions[Math.floor(Math.random() * actions.length)],
                () => styles[Math.floor(Math.random() * styles.length)]
            ];
            
            // Èö®Ê©üÊâì‰∫ÇÁ∂≠Â∫¶È†ÜÂ∫è
            const shuffled = dimensions.sort(() => Math.random() - 0.5);
            
            // ÈÅ∏Êìá 2-4 ÂÄãÁ∂≠Â∫¶
            for (let i = 0; i < numParts && i < shuffled.length; i++) {
                comboParts.push(shuffled[i]());
            }
            
            const randomCombination = comboParts.join(' ');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Ë´ãÊ†πÊìö‰ª•‰∏ãÁµÑÂêàÂÖÉÁ¥†ÔºåÁîüÊàê‰∏ÄÂÄãÁç®Áâπ„ÄÅÊúâÂâµÊÑèÁöÑÊ≠åÊõ≤‰∏ªÈ°åÔºà4-15Â≠óÔºâ„ÄÇ

„ÄêÁµÑÂêàÂÖÉÁ¥†„Äë
${comboParts.join('„ÄÅ')}

„ÄêË¶ÅÊ±Ç„Äë
- Âè™Ëº∏Âá∫‰∏ªÈ°åÊñáÂ≠óÊú¨Ë∫´Ôºå‰∏çË¶ÅÊ®ôÈªûÁ¨¶Ëôü„ÄÅÂºïËôü„ÄÅËß£Èáã
- ÂøÖÈ†àÈùàÊ¥ªÈÅãÁî®‰∏äËø∞ÂÖÉÁ¥†Ôºå‰ΩÜÂèØ‰ª•ÈáçÊñ∞ÊéíÂàó„ÄÅÁµÑÂêà„ÄÅÂª∂‰º∏
- ÁõÆÊ®ôÊòØÂâµÈÄ†‰∏ÄÂÄãÂÖ∑ÊúâÁï´Èù¢ÊÑü„ÄÅÊÉÖÁ∑íÂºµÂäõ„ÄÅÈÅ©ÂêàÂØ´Ê≠åÁöÑ‰∏ªÈ°å
- ÈÅøÂÖçËÄÅÂ•óË°®ÈÅîÔºàÂ¶ÇÔºöÊàëÊÑõ‰Ω†„ÄÅÊÉ≥Âøµ‰Ω†„ÄÅËøΩÂ§¢„ÄÅÈùíÊò•Á≠âÔºâ
- ÂèØ‰ª•ÊòØÔºöÂ†¥ÊôØ+ÊÉÖÊÑü„ÄÅÊôÇÈñì+Âãï‰Ωú„ÄÅÁâ©‰ª∂+ÊÑèË±°„ÄÅÊäΩË±°Ê¶ÇÂøµÁ≠â‰ªª‰ΩïÂâµÊÑèÁµÑÂêà

„ÄêÂâµ‰ΩúÊñπÂêëÂèÉËÄÉ„Äë
- Â†¥ÊôØ+ÊôÇÈñìÔºöÊ∑±Â§úÁöÑÂú∞ÈêµÁ´ô„ÄÅÂçàÂæåÁöÑÂíñÂï°Â∫ó
- ÊÉÖÊÑü+Áâ©‰ª∂ÔºöÈåØÈÅéÁöÑ‰ø°„ÄÅÈÅ∫ÂøòÁöÑÈë∞Âåô
- ÊôÇÈñì+Âãï‰ΩúÔºöÈÇ£Âπ¥Â§èÂ§©ÂØ´Áµ¶‰Ω†ÁöÑ„ÄÅÊò®Â§©Áïô‰∏ãÁöÑ
- Áâ©‰ª∂+Â†¥ÊôØÔºöÊòüÁ©∫‰∏ãÁöÑÈêòËÅ≤„ÄÅÈõ®Â§úÁöÑÂΩ©Ëôπ
- ÂèØ‰ª•Ëá™Áî±ÁµÑÂêà‰ª•‰∏äÂÖÉÁ¥†ÔºåÂâµÈÄ†ÂÖ®Êñ∞Ë°®ÈÅî

Ë´ãÈÅãÁî®„Äå${randomCombination}„ÄçÈÄô‰∫õÂÖÉÁ¥†ÔºåÁîüÊàê‰∏ÄÂÄãÁç®Áâπ‰∏îÈÅ©ÂêàÂØ´Ê≠åÁöÑ‰∏ªÈ°åÔºö` }] }],
                        generationConfig: {
                            temperature: 1.4,
                            topK: 60,
                            topP: 0.99,
                            maxOutputTokens: 100,
                        }
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let theme = data.candidates[0].content.parts[0].text.trim();
                // Ê∏ÖÁêÜÂèØËÉΩÁöÑÊ®ôÈªûÂíåÂºïËôü
                theme = theme.replace(/^["'„Äå„Äç„Äé„Äè„Äê„Äë„Ää„Äã()ÔºàÔºâ\[\]]+|["'„Äå„Äç„Äé„Äè„Äê„Äë„Ää„Äã()ÔºàÔºâ\[\]]+$/g, '');
                theme = theme.replace(/^[Ôºö:]\s*/, '').replace(/\s*[Ôºö:]$/, '');
                
                if (theme) {
                    document.getElementById('theme').value = theme;
                    saveFormState();
                } else {
                    throw new Error('ÁîüÊàêÁöÑ‰∏ªÈ°åÁÇ∫Á©∫');
                }
            } catch (error) {
                alert('ÁîüÊàêÂ§±ÊïóÔºö' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ===== Èö®Ê©üÈùàÊÑü =====
        async function randomFill() {
            const theme = document.getElementById('theme').value.trim();
            if (!theme) { 
                alert('Ë´ãÂÖàÂ°´ÂØ´‰∏ªÈ°åÔºåÊàñ‰ΩøÁî®„ÄåAI ÈùàÊÑü„ÄçÊåâÈàïÁîüÊàê‰∏ªÈ°å'); 
                return; 
            }

            const apiKey = await getApiKey();
            if (!apiKey) { 
                alert('Ë´ãÂÖàË®≠ÂÆö API ÈáëÈë∞'); 
                openApiModal(); 
                return; 
            }

            const btn = document.getElementById('randomFillBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ ÂàÜÊûê‰∏≠...';
            btn.disabled = true;

            // Áç≤ÂèñÊâÄÊúâÂèØÈÅ∏ÁöÑÈ¢®Ê†ºÂíåÊÉÖÊÑüÈÅ∏È†Ö
            const genreOptions = Array.from(document.querySelectorAll('#genreContainer input[type="checkbox"]')).map(cb => cb.value);
            const moodOptions = Array.from(document.querySelectorAll('#moodContainer input[type="checkbox"]')).map(cb => cb.value);
            const instrumentOptions = Array.from(document.querySelectorAll('#instrumentsContainer input[type="checkbox"]')).map(cb => cb.value);

            try {
                // Áî® API Ê†πÊìö‰∏ªÈ°åÂàÜÊûêÂ∞çÊáâÁöÑÈ¢®Ê†ºÂíåÊÉÖÊÑü
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Ê†πÊìö‰ª•‰∏ãÊ≠åÊõ≤‰∏ªÈ°åÔºåÂæûÊèê‰æõÁöÑÈÅ∏È†Ö‰∏≠ÈÅ∏ÊìáÊúÄÈÅ©ÂêàÁöÑÈü≥Ê®ÇÈ¢®Ê†º„ÄÅÊÉÖÊÑüÊ∞õÂúçÂíåÊ®ÇÂô®„ÄÇ

‰∏ªÈ°åÔºö${theme}

ÂèØÈÅ∏ÁöÑÈü≥Ê®ÇÈ¢®Ê†ºÔºàÈÅ∏2-3ÂÄãÔºâÔºö${genreOptions.join(', ')}

ÂèØÈÅ∏ÁöÑÊÉÖÊÑüÊ∞õÂúçÔºàÈÅ∏1-2ÂÄãÔºâÔºö${moodOptions.join(', ')}

ÂèØÈÅ∏ÁöÑÊ®ÇÂô®ÔºàÈÅ∏2-4ÂÄãÔºâÔºö${instrumentOptions.join(', ')}

Ë´ãÁî® JSON Ê†ºÂºèÂõûË¶ÜÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÂÖ∂‰ªñÊñáÂ≠óÔºö
{
  "genres": ["ÈÅ∏ÊìáÁöÑÈ¢®Ê†º1", "ÈÅ∏ÊìáÁöÑÈ¢®Ê†º2"],
  "moods": ["ÈÅ∏ÊìáÁöÑÊÉÖÊÑü1"],
  "instruments": ["Ê®ÇÂô®1", "Ê®ÇÂô®2", "Ê®ÇÂô®3"],
  "songType": "vocal Êàñ instrumental",
  "lyricStyle": "Áõ¥ÁôΩÊïò‰∫ã/ÊÑèË±°Ë©©ÊÑè/ÊïÖ‰∫ãÊÄß/Âè£Ë™ûÂåñ/Â∞çË©±Âºè/ÊäΩË±°Ê¶ÇÂøµ ÂÖ∂‰∏≠‰∏ÄÂÄã",
  "songVibe": "‰∏ªÊµÅÂïÜÊ•≠/Áç®Á´ãËóùË°ì/ÁúüÊëØÂãï‰∫∫/Ê¥æÂ∞çÂó®Ê≠å/ÊîæÈ¨ÜÁôÇÁôí/Âè≤Ë©©Á£ÖÁ§¥ ÂÖ∂‰∏≠‰∏ÄÂÄã"
}` }] }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 500,
                        }
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let aiResult;
                try {
                    const text = data.candidates[0].content.parts[0].text.trim();
                    // ÁßªÈô§ÂèØËÉΩÁöÑ markdown Ê®ôË®ò
                    const jsonText = text.replace(/```json\n?|\n?```/g, '').trim();
                    aiResult = JSON.parse(jsonText);
                } catch (parseError) {
                    console.warn('AI ÂõûÊáâËß£ÊûêÂ§±ÊïóÔºå‰ΩøÁî®Èö®Ê©üÈÅ∏Êìá');
                    aiResult = null;
                }

                // Ê∏ÖÈô§ÊâÄÊúâÂ§öÈÅ∏
                ['genre', 'mood', 'instruments', 'language'].forEach(type => clearAll(type));

                if (aiResult) {
                    // Ê†πÊìö AI Âª∫Ë≠∞Ë®≠ÂÆöÈ¢®Ê†º
                    if (aiResult.genres) {
                        aiResult.genres.forEach(genre => {
                            const cb = document.querySelector(`#genreContainer input[value="${genre}"]`);
                            if (cb) cb.checked = true;
                        });
                        updateMultiSelect('genre');
                    }

                    // Ê†πÊìö AI Âª∫Ë≠∞Ë®≠ÂÆöÊÉÖÊÑü
                    if (aiResult.moods) {
                        aiResult.moods.forEach(mood => {
                            const cb = document.querySelector(`#moodContainer input[value="${mood}"]`);
                            if (cb) cb.checked = true;
                        });
                        updateMultiSelect('mood');
                    }

                    // Ê†πÊìö AI Âª∫Ë≠∞Ë®≠ÂÆöÊ®ÇÂô®
                    if (aiResult.instruments) {
                        aiResult.instruments.forEach(inst => {
                            const cb = document.querySelector(`#instrumentsContainer input[value="${inst}"]`);
                            if (cb) cb.checked = true;
                        });
                        updateMultiSelect('instruments');
                    }

                    // Ë®≠ÂÆöÊ≠åÊõ≤È°ûÂûã
                    if (aiResult.songType) {
                        const songTypeRadio = document.querySelector(`input[name="songType"][value="${aiResult.songType}"]`);
                        if (songTypeRadio) {
                            songTypeRadio.checked = true;
                            songTypeRadio.dispatchEvent(new Event('change'));
                        }
                    }

                    // Ë®≠ÂÆöÊ≠åË©ûÈ¢®Ê†º
                    if (aiResult.lyricStyle) {
                        const lyricStyleMap = {
                            'Áõ¥ÁôΩÊïò‰∫ã': 'Áõ¥ÁôΩÊïò‰∫ã',
                            'ÊÑèË±°Ë©©ÊÑè': 'ÊÑèË±°Ë©©ÊÑè',
                            'ÊïÖ‰∫ãÊÄß': 'ÊïÖ‰∫ãÊÄß',
                            'Âè£Ë™ûÂåñ': 'Âè£Ë™ûÂåñ',
                            'Â∞çË©±Âºè': 'Â∞çË©±Âºè',
                            'ÊäΩË±°Ê¶ÇÂøµ': 'ÊäΩË±°Ê¶ÇÂøµ'
                        };
                        const lyricStyleEl = document.getElementById('lyricStyle');
                        if (lyricStyleEl && lyricStyleMap[aiResult.lyricStyle]) {
                            lyricStyleEl.value = lyricStyleMap[aiResult.lyricStyle];
                        }
                    }

                    // Ë®≠ÂÆöÊ≠åÊõ≤Ê∞õÂúç
                    if (aiResult.songVibe) {
                        const songVibeMap = {
                            '‰∏ªÊµÅÂïÜÊ•≠': 'radio-ready, catchy, mainstream',
                            'Áç®Á´ãËóùË°ì': 'indie, artistic, unique',
                            'ÁúüÊëØÂãï‰∫∫': 'emotional, heartfelt, sincere',
                            'Ê¥æÂ∞çÂó®Ê≠å': 'party, fun, groovy',
                            'ÊîæÈ¨ÜÁôÇÁôí': 'chill, relaxed, laid-back',
                            'Âè≤Ë©©Á£ÖÁ§¥': 'epic, grand, powerful'
                        };
                        const songVibeEl = document.getElementById('songVibe');
                        if (songVibeEl && songVibeMap[aiResult.songVibe]) {
                            songVibeEl.value = songVibeMap[aiResult.songVibe];
                        }
                    }
                } else {
                    // AI Ëß£ÊûêÂ§±ÊïóÊôÇ‰ΩøÁî®Èö®Ê©üÈÅ∏Êìá
                    ['genre', 'mood', 'instruments'].forEach(type => {
                        const container = document.getElementById(`${type}Container`);
                        if (!container) return;
                        const allCbs = Array.from(container.querySelectorAll('input[type="checkbox"]'));
                        const shuffled = shuffleArray(allCbs);
                        const count = type === 'instruments' ? Math.floor(Math.random() * 4) + 1 : Math.floor(Math.random() * 2) + 1;
                        shuffled.slice(0, count).forEach(cb => cb.checked = true);
                        updateMultiSelect(type);
                    });

                    // Èö®Ê©üÊ≠åÊõ≤È°ûÂûãÔºàÂÅèÂêë vocalÔºâ
                    const songTypeRadio = document.querySelector(`input[name="songType"][value="vocal"]`);
                    if (songTypeRadio) {
                        songTypeRadio.checked = true;
                        songTypeRadio.dispatchEvent(new Event('change'));
                    }
                }
                
                // Ë™ûË®ÄÂ§öÈÅ∏Ôºà1-2Á®ÆË™ûË®ÄÔºâ
                const langContainer = document.getElementById('languageContainer');
                if (langContainer) {
                    const langCbs = Array.from(langContainer.querySelectorAll('input[type="checkbox"]'));
                    const shuffledLangs = shuffleArray(langCbs);
                    const langCount = Math.floor(Math.random() * 2) + 1;
                    shuffledLangs.slice(0, langCount).forEach(cb => cb.checked = true);
                    updateMultiSelect('language');
                }
                
                // Èö®Ê©üÈÅ∏ÊìáÂáΩÊï∏
                const randomSelect = (id) => {
                    const sel = document.getElementById(id);
                    if (!sel) return;
                    const opts = sel.options;
                    if (opts.length > 0) {
                        sel.selectedIndex = Math.floor(Math.random() * opts.length);
                    }
                };
                
                // ‰∫∫ËÅ≤ÂíåÊ≠åË©ûË®≠ÂÆö
                ['voice', 'lyricStyle', 'songVibe'].forEach(randomSelect);
                
                saveFormState();
            } catch (error) {
                alert('ÁîüÊàêÂ§±ÊïóÔºö' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ===== ÁîüÊàêÁµêÊûúÂÑ≤Â≠ò (IndexedDB) =====
        async function saveGeneratedResult() {
            try {
                const resultData = {
                    versions: generatedVersions,
                    album: generatedAlbum,
                    timestamp: Date.now(),
                    prompt: lastPromptText
                };
                await saveToIndexedDB(RESULT_STORE, 'lastResult', resultData);
            } catch (e) {
                console.warn('Save result failed:', e);
            }
        }

        async function loadGeneratedResult() {
            try {
                const data = await loadFromIndexedDB(RESULT_STORE, 'lastResult');
                if (data) {
                    generatedVersions = data.versions || [];
                    generatedAlbum = data.album || null;
                    lastPromptText = data.prompt || '';
                    
                    if (generatedAlbum && generatedAlbum.tracks && generatedAlbum.tracks.length > 0) {
                        renderAlbum(generatedAlbum);
                        document.getElementById('resultSection').classList.add('show');
                    } else if (generatedVersions.length > 0) {
                        renderVersions(generatedVersions);
                        document.getElementById('resultSection').classList.add('show');
                    }
                    updateSafetyPanel();
                }
            } catch (e) {
                console.warn('Load result failed:', e);
            }
        }

        // ===== Ë©ûÂ∫´ÁÆ°ÁêÜ (IndexedDB) =====
        async function loadLibraryFromDB() {
            try {
                const data = await loadFromIndexedDB(LIBRARY_STORE, 'songs');
                savedSongs = data || [];
            } catch (e) {
                console.warn('Load library failed:', e);
                savedSongs = [];
            }
        }

        async function saveLibraryToDB() {
            try {
                await saveToIndexedDB(LIBRARY_STORE, 'songs', savedSongs);
            } catch (e) {
                console.warn('Save library failed:', e);
                throw e;
            }
        }

        async function addToLibrary(idx) {
            const v = generatedVersions[idx];
            if (!v || !v.lyrics.trim()) return alert('Ê≤íÊúâÂÖßÂÆπÂèØÊî∂Ëóè!');
            
            savedSongs.unshift({
                id: Date.now(),
                theme: document.getElementById('theme').value || 'Êú™ÂëΩÂêç',
                date: new Date().toLocaleString(),
                lyrics: v.lyrics,
                stylePrompt: v.stylePrompt
            });

            try {
                await saveLibraryToDB();
                renderLibrary();
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = '‚úÖ Â∑≤Êî∂Ëóè';
                setTimeout(() => btn.textContent = orig, 1500);
            } catch (e) {
                alert('ÂÑ≤Â≠òÂ§±Êïó: ' + e.message);
                savedSongs.shift();
            }
        }

        async function addTrackToLibrary(idx) {
            const track = generatedAlbum?.tracks[idx];
            if (!track || !track.lyrics.trim()) return alert('Ê≤íÊúâÂÖßÂÆπÂèØÊî∂Ëóè!');
            
            savedSongs.unshift({
                id: Date.now(),
                theme: `${generatedAlbum.name} - ${track.title}`,
                date: new Date().toLocaleString(),
                lyrics: track.lyrics,
                stylePrompt: track.stylePrompt
            });

            try {
                await saveLibraryToDB();
                renderLibrary();
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = '‚úÖ Â∑≤Êî∂Ëóè';
                setTimeout(() => btn.textContent = orig, 1500);
            } catch (e) {
                alert('ÂÑ≤Â≠òÂ§±Êïó: ' + e.message);
                savedSongs.shift();
            }
        }

        async function addAlbumToLibrary() {
            if (!generatedAlbum || !generatedAlbum.tracks || generatedAlbum.tracks.length === 0) {
                return alert('Ê≤íÊúâÂ∞àËºØÂÖßÂÆπÂèØÊî∂Ëóè!');
            }
            
            // Êî∂ËóèÊï¥ÂºµÂ∞àËºØÁÇ∫‰∏ÄÁ≠ÜË®òÈåÑ
            const albumLyrics = generatedAlbum.tracks.map((track, i) => 
                `=== Á¨¨ ${i + 1} È¶ñÔºö${track.title} ===\n\n${track.lyrics}`
            ).join('\n\n\n');
            
            const allStylePrompts = generatedAlbum.tracks.map(t => t.stylePrompt).join(' | ');
            
            savedSongs.unshift({
                id: Date.now(),
                theme: `„ÄêÂ∞àËºØ„Äë${generatedAlbum.name}`,
                date: new Date().toLocaleString(),
                lyrics: albumLyrics,
                stylePrompt: allStylePrompts,
                isAlbum: true,
                albumData: generatedAlbum
            });

            try {
                await saveLibraryToDB();
                renderLibrary();
                const btn = event.target;
                const orig = btn.textContent;
                btn.textContent = '‚úÖ Â∑≤Êî∂Ëóè';
                setTimeout(() => btn.textContent = orig, 1500);
            } catch (e) {
                alert('ÂÑ≤Â≠òÂ§±Êïó: ' + e.message);
                savedSongs.shift();
            }
        }

        function exportAlbum() {
            if (!generatedAlbum || !generatedAlbum.tracks || generatedAlbum.tracks.length === 0) {
                return alert('Ê≤íÊúâÂ∞àËºØÂÖßÂÆπÂèØÂåØÂá∫!');
            }
            
            const data = {
                albumName: generatedAlbum.name,
                trackCount: generatedAlbum.tracks.length,
                tracks: generatedAlbum.tracks.map((track, i) => ({
                    number: i + 1,
                    title: track.title,
                    lyrics: track.lyrics.split('\n'),
                    stylePrompt: track.stylePrompt
                })),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${generatedAlbum.name}_${Date.now()}.json`;
            link.click();
        }

        async function deleteFromLibrary(id) {
            if (!confirm('Á¢∫ÂÆöÂà™Èô§?')) return;
            savedSongs = savedSongs.filter(s => s.id !== id);
            await saveLibraryToDB();
            renderLibrary();
        }

        async function loadFromLibrary(id) {
            const song = savedSongs.find(s => s.id === id);
            if (song) {
                document.getElementById('theme').value = song.theme;
                generatedVersions = [{ lyrics: song.lyrics, stylePrompt: song.stylePrompt || '' }];
                generatedAlbum = null;
                renderVersions(generatedVersions);
                await saveGeneratedResult();
                document.getElementById('resultSection').classList.add('show');
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function renderLibrary() {
            document.getElementById('libCount').textContent = savedSongs.length;
            const list = document.getElementById('libraryList');
            if (savedSongs.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:30px;">Ë©ûÂ∫´ÊòØÁ©∫ÁöÑ</p>';
                return;
            }
            list.innerHTML = savedSongs.map(s => `
                <div class="library-item">
                    <div class="lib-item-header">
                        <span>${escapeHtml(s.theme)}</span>
                        <span class="lib-item-date">${s.date}</span>
                    </div>
                    <div class="lib-preview">${escapeHtml(s.lyrics.substring(0, 80))}...</div>
                    <div class="lib-actions">
                        <button class="btn-load" onclick="loadFromLibrary(${s.id})">‚úèÔ∏è ËºâÂÖ•</button>
                        <button class="btn-delete" onclick="deleteFromLibrary(${s.id})">üóëÔ∏è Âà™Èô§</button>
                    </div>
                </div>
            `).join('');
        }

        function exportLibrary() {
            if (savedSongs.length === 0) return alert('Ë©ûÂ∫´ÊòØÁ©∫ÁöÑ');
            const blob = new Blob([JSON.stringify(savedSongs, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `lyrics_library_${Date.now()}.json`;
            link.click();
        }

        async function importLibrary(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error();
                    savedSongs = [...data, ...savedSongs];
                    await saveLibraryToDB();
                    renderLibrary();
                    alert(`ÊàêÂäüÂåØÂÖ• ${data.length} È¶ñ!`);
                } catch { alert('ÂåØÂÖ•Â§±Êïó'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ===== Enter ÈçµÊîØÊè¥ =====
        document.getElementById('theme').addEventListener('keypress', e => { if (e.key === 'Enter') generateLyrics(); });
        document.getElementById('apiKeyInput').addEventListener('keypress', e => { if (e.key === 'Enter') saveApiKey(); });

        // ===== ÊåâÈàï‰∫ã‰ª∂Áõ£ËÅΩ =====
        document.getElementById('generateThemeBtn').addEventListener('click', generateRandomTheme);
        document.getElementById('randomFillBtn').addEventListener('click', randomFill);
        document.getElementById('generateBtn').addEventListener('click', generateLyrics);
        document.querySelectorAll('select, input, textarea').forEach(el => {
            el.addEventListener('change', updatePromptSummary);
        });

        // ===== ÂàùÂßãÂåñ =====
        async function init() {
            await initIndexedDB();
            await loadFormState();
            await loadLibraryFromDB();
            await loadGeneratedResult();
            await loadHistory();
            renderPresetOptions();
            updatePromptSummary();
            renderLibrary();
        }

        init();
    </script>
</body>
</html>
